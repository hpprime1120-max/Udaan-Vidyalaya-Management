<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Udaan Vidhyalay - School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Babel for on-the-fly JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS for Excel Import -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- html2canvas for Receipt Download -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(-45deg, #0f172a, #312e81, #581c87, #831843, #1e1b4b);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        color: #f4f4f5;
        min-height: 100vh;
      }

      @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
      ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
      
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }

      /* Print Styles */
      @media print {
        body * {
          visibility: hidden;
        }
        #root {
          display: none;
        }
        .print-container, .print-container * {
          visibility: visible;
        }
        .print-container {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          min-height: 100%;
          background: white;
          color: black;
          z-index: 9999;
          padding: 20px;
          display: flex;
          flex-direction: column;
          align-items: center;
        }
        .no-print {
          display: none !important;
        }
        /* Hide background gradients for print */
        body {
          background: white !important;
        }
      }
    </style>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module" data-presets="react,typescript">
import React, { useState, useEffect, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";
import { 
  ShieldCheck, LayoutDashboard, Users, Banknote, CheckSquare, FileSpreadsheet, LogOut, School, GraduationCap, X,
  Plus, Trash2, Edit, Save, Wand2, AlertCircle, Calendar, Download, Filter, CopyPlus, RotateCcw, Search, Lock, Sparkles,
  CheckCircle, XCircle, History, ChevronDown, ChevronUp, Printer, CreditCard, Wallet, Receipt,
  BrainCircuit, UserPlus, IndianRupee, Phone, Mail, ChevronLeft, ChevronRight, Award, PieChart, Menu, Upload, FileDown,
  Loader2, Check, FileImage, ArrowRight, User
} from 'lucide-react';
import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

// --- CONSTANTS & TYPES ---
const View = {
  DASHBOARD: 'DASHBOARD',
  STUDENTS: 'STUDENTS',
  TEACHERS: 'TEACHERS',
  FEES: 'FEES',
  ATTENDANCE: 'ATTENDANCE',
  EXAMS: 'EXAMS',
  SETTINGS: 'SETTINGS'
};

// --- DB SERVICE ---
const STORAGE_KEYS = {
  STUDENTS: 'uv_students_v1',
  TEACHERS: 'uv_teachers_v1',
  TEACHER_ATTENDANCE: 'uv_teacher_attendance_v1',
  FEES: 'uv_fees_v1',
  ATTENDANCE: 'uv_attendance_v1',
  EXAMS: 'uv_exams_v1',
};

class DatabaseService {
  // --- Teachers ---
  getTeachers() {
    const data = localStorage.getItem(STORAGE_KEYS.TEACHERS);
    return data ? JSON.parse(data) : [];
  }

  saveTeacher(teacher) {
    const teachers = this.getTeachers();
    const existingIndex = teachers.findIndex(t => t.id === teacher.id);
    if (existingIndex >= 0) { teachers[existingIndex] = teacher; } else { teachers.push(teacher); }
    localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify(teachers));
  }

  deleteTeacher(id) {
    const teachers = this.getTeachers().filter(t => t.id !== id);
    localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify(teachers));
  }

  getTeacherAttendance() {
    const data = localStorage.getItem(STORAGE_KEYS.TEACHER_ATTENDANCE);
    return data ? JSON.parse(data) : [];
  }

  saveTeacherAttendance(record) {
    const data = this.getTeacherAttendance();
    const index = data.findIndex(d => d.id === record.id);
    if (index >= 0) data[index] = record; else data.push(record);
    localStorage.setItem(STORAGE_KEYS.TEACHER_ATTENDANCE, JSON.stringify(data));
  }

  getTeacherCount() { return this.getTeachers().length; }

  // --- Students ---
  getStudents() {
    const data = localStorage.getItem(STORAGE_KEYS.STUDENTS);
    return data ? JSON.parse(data) : [];
  }

  saveStudent(student) {
    const students = this.getStudents();
    const existingIndex = students.findIndex(s => s.id === student.id);
    if (existingIndex >= 0) { students[existingIndex] = student; } else { students.push(student); }
    localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
  }

  deleteStudent(id) {
    const students = this.getStudents().filter(s => s.id !== id);
    localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
    this.cleanupRelatedRecords(id);
  }

  cleanupRelatedRecords(studentId) {
    const fees = this.getFees().filter(f => f.studentId !== studentId);
    localStorage.setItem(STORAGE_KEYS.FEES, JSON.stringify(fees));
    const att = this.getAttendance().filter(a => a.studentId !== studentId);
    localStorage.setItem(STORAGE_KEYS.ATTENDANCE, JSON.stringify(att));
    const exams = this.getExams().filter(e => e.studentId !== studentId);
    localStorage.setItem(STORAGE_KEYS.EXAMS, JSON.stringify(exams));
  }

  getNextRollNo() {
    const students = this.getStudents();
    if (students.length === 0) return 1001;
    const maxRoll = Math.max(...students.map(s => s.rollNo));
    return maxRoll + 1;
  }

  // --- Fees ---
  getFees() {
    const data = localStorage.getItem(STORAGE_KEYS.FEES);
    return data ? JSON.parse(data) : [];
  }

  saveFeeRecord(record) {
    const fees = this.getFees();
    const index = fees.findIndex(f => f.id === record.id);
    if (index >= 0) fees[index] = record; else fees.push(record);
    localStorage.setItem(STORAGE_KEYS.FEES, JSON.stringify(fees));
  }

  // --- Attendance ---
  getAttendance() {
    const data = localStorage.getItem(STORAGE_KEYS.ATTENDANCE);
    return data ? JSON.parse(data) : [];
  }

  saveAttendance(record) {
    const data = this.getAttendance();
    const index = data.findIndex(d => d.id === record.id);
    if (index >= 0) data[index] = record; else data.push(record);
    localStorage.setItem(STORAGE_KEYS.ATTENDANCE, JSON.stringify(data));
  }

  // --- Exams ---
  getExams() {
    const data = localStorage.getItem(STORAGE_KEYS.EXAMS);
    return data ? JSON.parse(data) : [];
  }

  saveExamResult(result) {
    const data = this.getExams();
    const index = data.findIndex(d => d.id === result.id);
    if (index >= 0) data[index] = result; else data.push(result);
    localStorage.setItem(STORAGE_KEYS.EXAMS, JSON.stringify(data));
  }

  initializeData() {
    if (!localStorage.getItem(STORAGE_KEYS.STUDENTS)) { localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify([])); }
    if (!localStorage.getItem(STORAGE_KEYS.TEACHERS)) { localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify([])); }
  }
}

const db = new DatabaseService();

// --- GEMINI SERVICE & HELPERS ---
const getClient = () => {
    let apiKey = '';
    try { 
        if (typeof process !== 'undefined' && process.env && process.env.API_KEY) { 
            apiKey = process.env.API_KEY; 
        } 
    } catch (e) { 
        // Ignore environment access errors in pure browser context
    }
    
    // Fallback or return null if no key
    if (!apiKey) return null;
    return new GoogleGenAI({ apiKey });
}

const generateStudentReport = async (student, exams, attendance) => {
    const client = getClient();
    if (!client) return "API Key is missing or invalid configuration.";
    
    const academicData = exams.length > 0 
        ? exams.map(e => `- ${e.subject} (${e.examType}): ${e.marksObtained}/${e.totalMarks}`).join('\n')
        : "No exam records available.";

    const attendanceSummary = attendance.length > 0
        ? `Total Records: ${attendance.length}, Present: ${attendance.filter(a => a.status === 'Present').length}`
        : "No attendance records available.";

    const prompt = `
    Role: You are an expert academic counselor for "Udaan Vidhyalay".
    Task: Write a professional, concise student performance summary.
    Student: ${student.fullName} (Class: ${student.className}-${student.section}).
    
    Academic Data:
    ${academicData}
    
    Attendance Data:
    ${attendanceSummary}
    
    Output: One encouraging paragraph highlighting strengths and 1 area for improvement.
    `;
    
    try {
        const response = await client.models.generateContent({ 
            model: "gemini-2.5-flash", 
            contents: prompt,
            config: {
                systemInstruction: "You are a helpful school counselor. Keep responses professional and concise.",
                temperature: 0.7
            }
        });
        return response.text || "No report generated.";
    } catch (error) { return "Error with AI service."; }
};

const generateAttendanceAnalysis = async (records, totalStudents) => {
    const client = getClient();
    if (!client) return "API Key missing.";
    const prompt = `Analyze attendance: ${records.length} records, ${totalStudents} students. Give 3 bullet points.`;
    try {
        const response = await client.models.generateContent({ model: "gemini-2.5-flash", contents: prompt, config: { systemInstruction: "You are a school admin analyst." } });
        return response.text || "Analysis failed.";
    } catch (error) { return "Error with AI."; }
}

// --- LOGIN COMPONENT ---

const Login = ({ onLogin }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  
  // Google Auth Simulation State
  const [showGoogleModal, setShowGoogleModal] = useState(false);
  const [googleLoading, setGoogleLoading] = useState(false);

  const handleStandardLogin = (e) => {
    e.preventDefault();
    setError('');
    
    if (!username || !password) {
        setError('Please enter Admin ID and Password');
        return;
    }

    setLoading(true);
    // Simulate network delay for realism
    setTimeout(() => {
        if (username === 'admin' && password === '1234') {
            onLogin({
                name: 'Administrator',
                email: 'admin@udaan.edu',
                role: 'ADMIN',
                avatar: null
            });
        } else {
            setError('Invalid Credentials. Try Admin ID: admin, Pass: 1234');
            setLoading(false);
        }
    }, 800);
  };
  
  const handleGoogleLoginStep = (account) => {
      setGoogleLoading(true);
      setTimeout(() => {
          setGoogleLoading(false);
          setShowGoogleModal(false);
          onLogin({
              name: account.name,
              email: account.email,
              role: 'ADMIN',
              avatar: account.avatar
          });
      }, 1500);
  };

  return (
    <div className="min-h-screen flex items-center justify-center relative overflow-hidden p-4">
      <div className="bg-black/40 backdrop-blur-xl border border-white/10 p-8 rounded-2xl shadow-2xl w-full max-w-md z-10 transition-all duration-300">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-500/20 text-indigo-300 mb-4 border border-indigo-500/30 shadow-inner">
            <ShieldCheck size={32} />
          </div>
          <h1 className="text-3xl font-bold text-white">Udaan Vidhyalay</h1>
          <p className="text-zinc-400 text-sm mt-2">School Management System</p>
        </div>
        
        <form onSubmit={handleStandardLogin} className="space-y-6">
          <div className="space-y-2">
            <label className="block text-sm font-medium text-zinc-300">Admin ID</label>
            <input 
                type="text" 
                value={username} 
                onChange={e => setUsername(e.target.value)} 
                className="block w-full px-4 py-3 border border-white/10 rounded-lg bg-white/5 text-white focus:ring-2 focus:ring-indigo-500 outline-none placeholder-zinc-500 transition-all" 
                placeholder="Enter Admin ID" 
            />
          </div>
          
          <div className="space-y-2">
            <label className="block text-sm font-medium text-zinc-300">Password</label>
            <input 
                type="password" 
                value={password} 
                onChange={e => setPassword(e.target.value)} 
                className="block w-full px-4 py-3 border border-white/10 rounded-lg bg-white/5 text-white focus:ring-2 focus:ring-indigo-500 outline-none placeholder-zinc-500 transition-all" 
                placeholder="Enter Password" 
            />
          </div>
          
          {error && (
              <div className="text-red-300 text-sm text-center bg-red-500/10 p-2 rounded border border-red-500/20 flex items-center justify-center gap-2 animate-pulse">
                  <AlertCircle size={14}/> {error}
              </div>
          )}
          
          <button 
            type="submit" 
            disabled={loading}
            className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold transition shadow-lg shadow-indigo-900/30 transform active:scale-[0.98] flex justify-center items-center gap-2"
          >
            {loading ? <Loader2 className="animate-spin" size={20}/> : 'Secure Login'}
          </button>
        </form>

        <div className="my-6 flex items-center gap-4">
            <div className="h-px bg-white/10 flex-1"></div>
            <div className="text-xs text-zinc-500 uppercase tracking-wider font-medium">Or</div>
            <div className="h-px bg-white/10 flex-1"></div>
        </div>

        <button 
            type="button" 
            onClick={() => setShowGoogleModal(true)}
            className="w-full py-3 bg-white hover:bg-zinc-100 text-zinc-900 rounded-lg font-bold transition flex items-center justify-center gap-3 relative transform active:scale-[0.98]"
        >
            <svg className="w-5 h-5" viewBox="0 0 24 24">
                <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" />
                <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" />
                <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" />
                <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" />
            </svg>
            <span>Sign in with Google</span>
        </button>
      </div>

      {/* Realistic Google Auth Modal Simulation */}
      {showGoogleModal && (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-[400px] overflow-hidden animate-in zoom-in-95 duration-200">
                {googleLoading ? (
                    <div className="h-[400px] flex flex-col items-center justify-center p-8 space-y-4">
                        <Loader2 className="animate-spin text-blue-600" size={48} />
                        <p className="text-zinc-600 font-medium">Verifying Credentials...</p>
                    </div>
                ) : (
                    <>
                        <div className="p-6 border-b border-gray-100 flex items-center justify-between">
                             <div className="flex items-center gap-2">
                                <svg className="w-6 h-6" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4" /><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853" /><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05" /><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335" /></svg>
                                <span className="font-medium text-gray-700">Sign in with Google</span>
                             </div>
                             <button onClick={() => setShowGoogleModal(false)} className="text-gray-400 hover:text-gray-600"><X size={20}/></button>
                        </div>
                        <div className="p-4">
                            <h3 className="text-xl text-center text-gray-800 mb-2">Choose an account</h3>
                            <p className="text-sm text-center text-gray-500 mb-6">to continue to Udaan Vidhyalay</p>
                            
                            <div className="space-y-2">
                                <button 
                                    onClick={() => handleGoogleLoginStep({name: 'Udaan Admin', email: 'admin@udaan.edu', avatar: 'https://ui-avatars.com/api/?name=Udaan+Admin&background=0D8ABC&color=fff'})}
                                    className="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-200 transition text-left"
                                >
                                    <div className="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold">UA</div>
                                    <div>
                                        <div className="font-medium text-gray-900">Udaan Admin</div>
                                        <div className="text-sm text-gray-500">admin@udaan.edu</div>
                                    </div>
                                </button>
                                
                                <button 
                                    onClick={() => handleGoogleLoginStep({name: 'Principal Office', email: 'principal@udaan.edu', avatar: 'https://ui-avatars.com/api/?name=Principal&background=6366f1&color=fff'})}
                                    className="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg border border-transparent hover:border-gray-200 transition text-left"
                                >
                                    <div className="w-10 h-10 rounded-full bg-purple-600 text-white flex items-center justify-center font-bold">P</div>
                                    <div>
                                        <div className="font-medium text-gray-900">Principal Office</div>
                                        <div className="text-sm text-gray-500">principal@udaan.edu</div>
                                    </div>
                                </button>

                                <div className="border-t border-gray-100 my-2"></div>
                                
                                <button className="w-full flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition text-left text-gray-600">
                                    <div className="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center"><User size={20}/></div>
                                    <div className="font-medium">Use another account</div>
                                </button>
                            </div>
                        </div>
                        <div className="p-4 border-t border-gray-100 text-xs text-gray-500 text-center">
                            To continue, Google will share your name, email address, and language preference with Udaan Vidhyalay.
                        </div>
                    </>
                )}
            </div>
        </div>
      )}
    </div>
  );
};

// --- SIDEBAR COMPONENT ---
const Sidebar = ({ currentView, onChangeView, onLogout, isOpen, onClose, user }) => {
  const menuItems = [
    { id: View.DASHBOARD, label: 'Dashboard', icon: LayoutDashboard },
    { id: View.STUDENTS, label: 'Students', icon: Users },
    { id: View.TEACHERS, label: 'Teachers', icon: GraduationCap },
    { id: View.FEES, label: 'Fees Management', icon: Banknote },
    { id: View.ATTENDANCE, label: 'Attendance', icon: CheckSquare },
    { id: View.EXAMS, label: 'Exam Results', icon: FileSpreadsheet },
  ];

  return (
    <>
      {isOpen && <div className="fixed inset-0 bg-black/60 z-30 md:hidden backdrop-blur-sm" onClick={onClose} />}
      <div className={`fixed top-0 left-0 h-full w-64 bg-black/40 backdrop-blur-2xl border-r border-white/10 text-white shadow-2xl z-40 transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:z-20 flex flex-col`}>
        <div className="p-6 border-b border-white/10 flex items-center justify-between">
          <div className="flex items-center gap-3"><div className="p-2 bg-indigo-600 rounded-lg"><School size={24} /></div><div><h2 className="font-bold text-lg">Udaan</h2><span className="text-xs text-zinc-400 uppercase">Vidhyalay</span></div></div>
          <button onClick={onClose} className="md:hidden text-zinc-400 hover:text-white"><X size={24} /></button>
        </div>
        
        <nav className="flex-1 overflow-y-auto py-6 px-3 space-y-1 custom-scrollbar">
          {menuItems.map(item => (
            <button key={item.id} onClick={() => { onChangeView(item.id); onClose(); }} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${currentView === item.id ? 'bg-indigo-600/80 text-white' : 'text-zinc-400 hover:bg-white/10 hover:text-white'}`}>
              <item.icon size={20} /><span className="font-medium">{item.label}</span>
            </button>
          ))}
        </nav>
        
        {/* User Profile Section in Sidebar */}
        <div className="p-4 border-t border-white/10 bg-black/20">
            <div className="flex items-center gap-3 mb-3">
                {user?.avatar ? (
                    <img src={user.avatar} alt="User" className="w-10 h-10 rounded-full border border-white/20" />
                ) : (
                    <div className="w-10 h-10 rounded-full bg-indigo-500 flex items-center justify-center text-white font-bold">{user?.name?.charAt(0) || 'A'}</div>
                )}
                <div className="overflow-hidden">
                    <div className="font-bold text-sm truncate">{user?.name || 'Administrator'}</div>
                    <div className="text-xs text-zinc-400 truncate">{user?.email || 'admin@udaan.edu'}</div>
                </div>
            </div>
            <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-600/10 text-red-400 hover:bg-red-600 hover:text-white rounded-lg transition-colors text-sm font-bold border border-red-600/20">
                <LogOut size={16} /> Sign Out
            </button>
        </div>
      </div>
    </>
  );
};

// ... [Kept StudentManager, FeesManager, AttendanceManager, ExamManager, TeacherManager unchanged as they work fine] ...
// Re-inserting them condensed for the file, assuming they are part of the original large block.
// Since the prompt asks for "full code" in index.html, I must include all components.

// --- STUDENT MANAGER ---
const StudentManager = () => {
  const [students, setStudents] = useState([]);
  const [viewMode, setViewMode] = useState('LIST');
  const [searchTerm, setSearchTerm] = useState('');
  const [filterClass, setFilterClass] = useState('');
  const [filterSection, setFilterSection] = useState('');
  const [isEdit, setIsEdit] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiReport, setAiReport] = useState(null);
  const [saveAction, setSaveAction] = useState('SAVE');
  const fileInputRef = useRef(null);
  const [isSaving, setIsSaving] = useState(false);

  const initialFormState = { id: '', rollNo: 0, fullName: '', gender: 'Male', dateOfBirth: '', contactNumber: '', address: '', className: '', section: '', admissionDate: new Date().toISOString().split('T')[0] };
  const [formData, setFormData] = useState(initialFormState);

  useEffect(() => { loadStudents(); }, []);
  const loadStudents = () => { setStudents(db.getStudents()); };
  const generateNewCredentials = () => { const nextRoll = db.getNextRollNo(); return { id: `UV-${new Date().getFullYear()}-${nextRoll}`, rollNo: nextRoll }; };
  const handleAddNew = () => { setFormData({ ...initialFormState, ...generateNewCredentials() }); setIsEdit(false); setViewMode('FORM'); setAiReport(null); };
  const handleEdit = (student) => { setFormData(student); setIsEdit(true); setViewMode('FORM'); setAiReport(null); };
  const handleDelete = (id) => { if (confirm('Delete student?')) { db.deleteStudent(id); loadStudents(); } };
  
  const handleSave = (e) => {
    e.preventDefault();
    if(!formData.fullName || !formData.className) { alert("Fill required fields"); return; }
    setIsSaving(true);
    setTimeout(() => {
        db.saveStudent(formData);
        loadStudents();
        setIsSaving(false);
        if(saveAction === 'SAVE_AND_NEW' && !isEdit) { 
            setFormData({...initialFormState, ...generateNewCredentials()}); 
        } else { 
            setViewMode('LIST'); 
        }
    }, 800);
  };

  const handleExportCSV = () => {
    if(students.length === 0) return alert("No data");
    const headers = ["ID,Roll,Name,Class,Section,Contact,Address"];
    const rows = students.map(s => `${s.id},${s.rollNo},"${s.fullName}",${s.className},${s.section},${s.contactNumber},"${s.address}"`);
    const blob = new Blob([headers.concat(rows).join('\n')], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'students.csv'; a.click();
  };

  const handleDownloadTemplate = () => {
      const headers = ["Name,Gender,DOB,Contact,Address,Class,Section"];
      const sample = ["John Doe,Male,2010-01-01,9876543210,123 Street City,1,A"];
      const blob = new Blob([headers.concat(sample).join('\n')], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'student_template.csv'; a.click();
  };

  const handleImportExcel = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
          try {
              const data = new Uint8Array(event.target.result);
              if(window.XLSX) {
                const workbook = window.XLSX.read(data, { type: 'array' });
                const jsonData = window.XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                let imported = 0;
                jsonData.forEach((row) => {
                    const getVal = (k) => { const key = Object.keys(row).find(x => x.toLowerCase().includes(k.toLowerCase())); return key ? row[key] : null; };
                    const name = getVal("Name");
                    if (name) {
                        const roll = db.getNextRollNo() + imported;
                        db.saveStudent({
                            id: `UV-${new Date().getFullYear()}-${roll}`, rollNo: roll, fullName: String(name),
                            gender: getVal("Gender")||'Male', dateOfBirth: getVal("DOB")||'', contactNumber: String(getVal("Contact")||''),
                            address: String(getVal("Address")||''), className: String(getVal("Class")||'1'), section: String(getVal("Section")||'A'),
                            admissionDate: new Date().toISOString().split('T')[0]
                        });
                        imported++;
                    }
                });
                alert(`Successfully imported ${imported} students from the file.`); 
                loadStudents();
              } else {
                alert("XLSX library not loaded");
              }
          } catch (e) { alert("Error parsing Excel."); }
      };
      reader.readAsArrayBuffer(file);
  };

  const handleGenerateAIReport = async () => {
    setAiLoading(true);
    const rep = await generateStudentReport(formData, db.getExams().filter(e=>e.studentId===formData.id), db.getAttendance().filter(a=>a.studentId===formData.id));
    setAiReport(rep); setAiLoading(false);
  };

  const filteredStudents = students.filter(s => {
      const matchesSearch = s.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || s.rollNo.toString().includes(searchTerm);
      const matchesClass = filterClass ? String(s.className) === String(filterClass) : true;
      const matchesSection = filterSection ? s.section === filterSection : true;
      return matchesSearch && matchesClass && matchesSection;
  });

  if (viewMode === 'LIST') {
    return (
      <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-lg border border-white/10 flex flex-col h-full">
        <div className="p-4 border-b border-white/10 flex flex-wrap gap-4 justify-between items-center">
            <div>
                <h2 className="text-xl font-bold">Student Directory</h2>
                <p className="text-xs text-zinc-400 mt-1">
                    {filteredStudents.length === students.length 
                        ? `Total Students: ${students.length}` 
                        : `Showing ${filteredStudents.length} of ${students.length} students`}
                </p>
            </div>
            <div className="flex gap-2">
                <button onClick={handleDownloadTemplate} className="p-2 bg-white/5 text-zinc-300 rounded-lg text-xs flex items-center gap-1 hover:bg-white/10"><FileDown size={14}/> Template</button>
                <input type="file" ref={fileInputRef} onChange={handleImportExcel} accept=".xlsx,.csv" className="hidden" />
                <button onClick={() => fileInputRef.current.click()} className="p-2 bg-green-600/20 text-green-300 rounded-lg flex items-center gap-1 text-xs hover:bg-green-600/30"><Upload size={14}/> Import</button>
                <button onClick={handleExportCSV} className="p-2 bg-white/5 text-zinc-200 rounded-lg hover:bg-white/10"><Download size={18}/></button>
                <button onClick={handleAddNew} className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md shadow-indigo-900/20 font-medium"><Plus size={18}/> Add Student</button>
            </div>
        </div>
        <div className="p-4 border-b border-white/10 flex flex-wrap gap-4 bg-white/5">
            <div className="relative flex-1 min-w-[200px]"><Search className="absolute left-3 top-2.5 text-zinc-500" size={16} /><input type="text" placeholder="Search by Name or Roll No..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-2 bg-black/20 border border-white/10 rounded-lg outline-none text-white focus:ring-1 focus:ring-indigo-500"/></div>
            <select value={filterClass} onChange={e=>setFilterClass(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="">All Classes</option>{[...Array(12)].map((_,i)=><option key={i} value={i+1}>{i+1}</option>)}</select>
            <select value={filterSection} onChange={e=>setFilterSection(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="">All Sections</option>{['A','B','C','D'].map(s=><option key={s} value={s}>{s}</option>)}</select>
        </div>
        <div className="overflow-auto flex-1 custom-scrollbar">
            <table className="w-full text-left text-sm text-zinc-300">
                <thead className="bg-white/5 sticky top-0 backdrop-blur-md"><tr><th className="p-4">Roll</th><th className="p-4">Name</th><th className="p-4">Class</th><th className="p-4">Contact</th><th className="p-4 text-right">Actions</th></tr></thead>
                <tbody>
                    {filteredStudents.map(s => (
                        <tr key={s.id} className="hover:bg-white/5 border-b border-white/5 transition-colors">
                            <td className="p-4 text-indigo-300 font-mono">#{s.rollNo}</td><td className="p-4 font-bold text-white">{s.fullName}</td>
                            <td className="p-4"><span className="px-2 py-1 bg-white/10 rounded text-xs font-medium">{s.className}-{s.section}</span></td><td className="p-4">{s.contactNumber}</td>
                            <td className="p-4 text-right"><button onClick={()=>handleEdit(s)} className="p-2 text-blue-300 hover:bg-blue-500/10 rounded"><Edit size={16}/></button><button onClick={()=>handleDelete(s.id)} className="p-2 text-red-300 hover:bg-red-500/10 rounded"><Trash2 size={16}/></button></td>
                        </tr>
                    ))}
                    {filteredStudents.length === 0 && <tr><td colSpan={5} className="p-8 text-center text-zinc-500">No students found.</td></tr>}
                </tbody>
            </table>
        </div>
      </div>
    );
  }
  return (
      <div className="max-w-4xl mx-auto h-full overflow-y-auto custom-scrollbar p-1">
          <div className="bg-black/40 backdrop-blur-xl rounded-xl border border-white/10 p-6 shadow-xl">
              <div className="flex justify-between mb-6 pb-4 border-b border-white/10">
                  <h2 className="text-xl font-bold text-white">{isEdit?'Edit Student Record':'New Student Registration'}</h2>
                  <button onClick={()=>setViewMode('LIST')} className="p-1 hover:bg-white/10 rounded-full"><X/></button>
              </div>
              <form onSubmit={handleSave} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div><label className="block text-sm mb-1 text-zinc-400">Full Name</label><input type="text" value={formData.fullName} onChange={e=>setFormData({...formData, fullName:e.target.value})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" required placeholder="Enter student name"/></div>
                  <div><label className="block text-sm mb-1 text-zinc-400">Class</label><select value={formData.className} onChange={e=>setFormData({...formData, className:e.target.value})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none [&>option]:bg-zinc-900"><option value="">Select Class</option>{[...Array(12)].map((_,i)=><option key={i} value={i+1}>{i+1}</option>)}</select></div>
                  <div><label className="block text-sm mb-1 text-zinc-400">Section</label><select value={formData.section} onChange={e=>setFormData({...formData, section:e.target.value})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none [&>option]:bg-zinc-900"><option value="">Select Section</option>{['A','B','C','D'].map(s=><option key={s} value={s}>{s}</option>)}</select></div>
                  <div><label className="block text-sm mb-1 text-zinc-400">Roll No</label><input type="number" value={formData.rollNo} onChange={e=>setFormData({...formData, rollNo:Number(e.target.value)})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"/></div>
                  <div><label className="block text-sm mb-1 text-zinc-400">Contact Number</label><input type="text" value={formData.contactNumber} onChange={e=>setFormData({...formData, contactNumber:e.target.value})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="10-digit mobile number"/></div>
                  <div><label className="block text-sm mb-1 text-zinc-400">Address</label><input type="text" value={formData.address} onChange={e=>setFormData({...formData, address:e.target.value})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Residential address"/></div>
                  <div><label className="block text-sm mb-1 text-zinc-400">Date of Birth</label><input type="date" value={formData.dateOfBirth} onChange={e=>setFormData({...formData, dateOfBirth:e.target.value})} className="w-full p-3 bg-white/5 border border-white/10 rounded-lg outline-none [color-scheme:dark]"/></div>
                  <div className="md:col-span-2 flex flex-col sm:flex-row gap-4 mt-6 pt-4 border-t border-white/10">
                      <button type="submit" onClick={()=>setSaveAction('SAVE')} disabled={isSaving} className="flex-1 bg-indigo-600 py-3 rounded-lg text-white font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 shadow-lg shadow-indigo-900/30 transition-transform active:scale-95">{isSaving ? <Loader2 className="animate-spin"/> : <Save size={20}/>} {isSaving ? 'Saving...' : 'Save Student'}</button>
                      {!isEdit && <button type="submit" onClick={()=>setSaveAction('SAVE_AND_NEW')} disabled={isSaving} className="flex-1 bg-white/10 py-3 rounded-lg text-indigo-300 font-bold hover:bg-white/20 border border-white/10 flex items-center justify-center gap-2"><CopyPlus size={20}/> Save & Add Another</button>}
                  </div>
              </form>
              {isEdit && (
                  <div className="mt-8 p-6 bg-gradient-to-br from-indigo-900/20 to-purple-900/20 rounded-xl border border-indigo-500/30">
                      <div className="flex justify-between items-center mb-4"><h3 className="font-bold flex gap-2 text-white"><Sparkles className="text-purple-400"/> AI Performance Insight</h3><button onClick={handleGenerateAIReport} disabled={aiLoading} className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm font-bold shadow-lg shadow-purple-900/40 transition-colors">{aiLoading ? 'Analyzing...' : 'Generate Report'}</button></div>
                      {aiReport && <div className="text-sm italic text-zinc-200 bg-black/40 p-5 rounded-xl border border-white/5 leading-relaxed">"{aiReport}"</div>}
                  </div>
              )}
          </div>
      </div>
  );
};

// --- FEES MANAGER ---
const FeesManager = () => {
  const [students, setStudents] = useState([]);
  const [fees, setFees] = useState([]);
  const [academicYear] = useState('2023-2024');
  const [expandedStudent, setExpandedStudent] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('ALL');
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [selectedPayment, setSelectedPayment] = useState(null);
  const [paymentForm, setPaymentForm] = useState({ amount: 0, mode: 'CASH', date: new Date().toISOString().split('T')[0], transactionId: '' });
  const [showReceipt, setShowReceipt] = useState(null);
  const [receiptStudent, setReceiptStudent] = useState(null);
  const [filterClass, setFilterClass] = useState('');
  const [filterSection, setFilterSection] = useState('');

  const SEMESTER_FEE = 11000;

  useEffect(() => { loadData(); }, []);
  const loadData = () => { setStudents(db.getStudents()); setFees(db.getFees()); };

  const getFeeRecord = (studentId) => {
    const existing = fees.find(f => f.studentId === studentId && f.academicYear === academicYear);
    return existing || { id: `${studentId}-${academicYear}`, studentId, academicYear, semester1Paid: false, semester2Paid: false, transactions: [] };
  };

  const getSemesterStats = (record, semester) => {
      const txns = record.transactions || [];
      const paid = txns.filter(t => t.semester === semester).reduce((sum, t) => sum + t.amount, 0);
      return { paid, due: SEMESTER_FEE - paid, status: paid >= SEMESTER_FEE ? 'PAID' : paid > 0 ? 'PARTIAL' : 'PENDING' };
  };

  const initiatePayment = (student, semester) => {
      const stats = getSemesterStats(getFeeRecord(student.id), semester);
      if (stats.status === 'PAID') return alert("Already Paid");
      setSelectedPayment({ studentId: student.id, studentName: student.fullName, semester, currentDue: stats.due });
      setPaymentForm({ amount: stats.due, mode: 'CASH', date: new Date().toISOString().split('T')[0], transactionId: '' });
      setShowPaymentModal(true);
  };

  const processPayment = (e) => {
      e.preventDefault();
      if (paymentForm.amount <= 0 || paymentForm.amount > selectedPayment.currentDue) return alert("Invalid Amount");
      const record = getFeeRecord(selectedPayment.studentId);
      const newTxn = { id: paymentForm.transactionId || `TXN-${Date.now()}`, date: paymentForm.date, amount: paymentForm.amount, type: paymentForm.mode, semester: selectedPayment.semester };
      const updated = { ...record, transactions: [...(record.transactions || []), newTxn] };
      const s1 = getSemesterStats(updated, 1); const s2 = getSemesterStats(updated, 2);
      updated.semester1Paid = s1.status === 'PAID'; updated.semester2Paid = s2.status === 'PAID';
      db.saveFeeRecord(updated); loadData(); setShowPaymentModal(false);
      handleShowReceipt(newTxn, students.find(s => s.id === selectedPayment.studentId));
  };

  const handleShowReceipt = (txn, student) => { setReceiptStudent(student); setShowReceipt(txn); };

  const handleDownloadReceipt = () => {
    const receiptElement = document.querySelector('.receipt-content');
    if (receiptElement && window.html2canvas) {
        window.html2canvas(receiptElement, { backgroundColor: '#ffffff' }).then(canvas => {
            const link = document.createElement('a');
            link.download = `receipt_${showReceipt.id}.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    } else {
        alert("Download failed. Please try Print -> Save as PDF.");
    }
  };
  
  const handleExportFees = () => {
      if (filteredStudents.length === 0) return alert("No data");
      const headers = ["Roll,Name,Class,Sem1,Sem2,TotalPaid"];
      const rows = filteredStudents.map(s => {
          const r = getFeeRecord(s.id);
          const s1 = getSemesterStats(r, 1).status; const s2 = getSemesterStats(r, 2).status;
          const paid = (r.transactions||[]).reduce((sum,t)=>sum+t.amount,0);
          return `${s.rollNo},"${s.fullName}",${s.className}-${s.section},${s1},${s2},${paid}`;
      });
      const blob = new Blob([headers.concat(rows).join('\n')], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'fees_report.csv'; a.click();
  };

  const filteredStudents = students.filter(s => {
      const record = getFeeRecord(s.id);
      const matchesSearch = s.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || s.rollNo.toString().includes(searchTerm);
      const matchesClass = filterClass ? String(s.className) === String(filterClass) : true;
      const matchesSection = filterSection ? s.section === filterSection : true;
      
      let matchesStatus = true;
      if (statusFilter !== 'ALL') {
          const s1 = getSemesterStats(record, 1).status; const s2 = getSemesterStats(record, 2).status;
          if (statusFilter === 'PAID') matchesStatus = (s1 === 'PAID' && s2 === 'PAID');
          else if (statusFilter === 'PENDING') matchesStatus = (s1 === 'PENDING' || s2 === 'PENDING');
          else if (statusFilter === 'PARTIAL') matchesStatus = (s1 === 'PARTIAL' || s2 === 'PARTIAL');
      }
      return matchesSearch && matchesStatus && matchesClass && matchesSection;
  });

  return (
    <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col relative">
      <div className="p-6 border-b border-white/10 space-y-4">
        <div className="flex justify-between items-center flex-wrap gap-4">
            <h2 className="text-xl font-bold flex items-center gap-2"><Banknote className="text-green-400" /> Fees Management</h2>
            <button onClick={handleExportFees} className="flex items-center gap-2 bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-sm hover:bg-white/10"><Download size={16}/> Export Report</button>
        </div>
        <div className="flex flex-wrap gap-4">
            <div className="relative flex-1 min-w-[200px]"><Search className="absolute left-3 top-2.5 text-zinc-500" size={16} /><input type="text" placeholder="Search..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="w-full pl-9 pr-3 py-2 bg-black/20 border border-white/10 rounded-lg outline-none text-white"/></div>
            <select value={filterClass} onChange={e=>setFilterClass(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="">All Classes</option>{[...Array(12)].map((_,i)=><option key={i} value={i+1}>{i+1}</option>)}</select>
            <select value={filterSection} onChange={e=>setFilterSection(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="">All Sections</option>{['A','B','C','D'].map(s=><option key={s} value={s}>{s}</option>)}</select>
            <select value={statusFilter} onChange={e=>setStatusFilter(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="ALL">All Status</option><option value="PAID">Paid</option><option value="PENDING">Pending</option><option value="PARTIAL">Partial</option></select>
        </div>
      </div>
      <div className="overflow-auto flex-1 custom-scrollbar">
        <table className="w-full text-left text-sm text-zinc-300 min-w-[900px]">
          <thead className="bg-white/5 sticky top-0 backdrop-blur-md"><tr><th className="p-4">Student</th><th className="p-4 text-center">Sem 1</th><th className="p-4 text-center">Sem 2</th><th className="p-4 text-center">Total Paid</th><th className="p-4 text-center">History</th></tr></thead>
          <tbody>
            {filteredStudents.map(student => {
              const rec = getFeeRecord(student.id);
              const s1 = getSemesterStats(rec, 1); const s2 = getSemesterStats(rec, 2);
              const renderBtn = (s, sem) => <button onClick={()=>initiatePayment(student, sem)} disabled={s.status==='PAID'} className={`px-4 py-1 rounded-full text-xs font-bold w-24 ${s.status==='PAID'?'bg-green-500/20 text-green-300 cursor-default':s.status==='PARTIAL'?'bg-yellow-500/20 text-yellow-300':'bg-white/10 hover:bg-indigo-600 text-zinc-300 hover:text-white'}`}>{s.status==='PAID'?'PAID':s.status==='PARTIAL'?'PARTIAL':'PAY'}</button>;
              return (
                <React.Fragment key={student.id}>
                    <tr className="border-b border-white/5 hover:bg-white/5">
                        <td className="p-4"><div className="font-bold text-white">{student.fullName}</div><div className="text-xs">Class {student.className}-{student.section}</div></td>
                        <td className="p-4 text-center">{renderBtn(s1,1)}</td><td className="p-4 text-center">{renderBtn(s2,2)}</td>
                        <td className="p-4 text-center font-mono">₹{(s1.paid+s2.paid).toLocaleString()}</td>
                        <td className="p-4 text-center"><button onClick={()=>setExpandedStudent(expandedStudent===student.id?null:student.id)} className="p-2 bg-white/5 rounded-lg hover:bg-white/10"><History size={16}/></button></td>
                    </tr>
                    {expandedStudent===student.id && (
                        <tr><td colSpan={5} className="p-4 bg-black/20"><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">{(rec.transactions||[]).map((t,i)=>(
                            <div key={i} className="p-3 bg-zinc-900 border border-white/10 rounded-lg flex justify-between items-center">
                                <div><div className="text-xs text-zinc-500">{t.date}</div><div className="font-bold text-white">₹{t.amount}</div><div className="text-xs text-indigo-300">{t.type} (Sem {t.semester})</div></div>
                                <button onClick={()=>handleShowReceipt(t,student)} className="p-2 bg-indigo-600 rounded text-white"><Printer size={14}/></button>
                            </div>
                        ))}</div>{(!rec.transactions?.length) && <div className="text-center text-zinc-500">No History</div>}</td></tr>
                    )}
                </React.Fragment>
              );
            })}
          </tbody>
        </table>
      </div>
      
      {/* PROFESSIONAL DARK THEME MODAL */}
      {showPaymentModal && selectedPayment && (
        <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="bg-[#18181b] w-full max-w-md rounded-2xl overflow-hidden border border-white/10 shadow-2xl animate-in zoom-in-95 duration-200">
                <div className="p-6 border-b border-white/10 flex justify-between items-start">
                    <div>
                        <h3 className="text-xl font-bold text-white">Collect Fees</h3>
                        <p className="text-sm text-zinc-400 mt-1">Semester {selectedPayment.semester} Payment</p>
                    </div>
                    <button onClick={() => setShowPaymentModal(false)} className="text-zinc-500 hover:text-white transition-colors">
                        <XCircle size={28} />
                    </button>
                </div>

                <form onSubmit={processPayment} className="p-6 space-y-6">
                    <div>
                        <label className="text-xs font-bold text-zinc-500 tracking-wider uppercase mb-2 block">Student</label>
                        <div className="text-xl font-bold text-white">{selectedPayment.studentName}</div>
                        <div className="text-sm text-zinc-400 font-mono mt-0.5">ID: {selectedPayment.studentId}</div>
                    </div>

                    <div className="bg-white/5 rounded-xl p-4 border border-white/5 space-y-2">
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-zinc-400">Total Fee</span>
                            <span className="font-medium text-white">₹{SEMESTER_FEE.toLocaleString()}</span>
                        </div>
                        <div className="flex justify-between items-center text-sm">
                            <span className="text-zinc-400">Pending Due</span>
                            <span className="font-bold text-red-400">₹{selectedPayment.currentDue.toLocaleString()}</span>
                        </div>
                    </div>

                    <div>
                        <label className="text-xs font-bold text-zinc-500 tracking-wider uppercase mb-2 block">Paying Amount (₹)</label>
                        <input 
                            type="number" 
                            value={paymentForm.amount}
                            onChange={e => setPaymentForm({...paymentForm, amount: Number(e.target.value)})}
                            className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-4 text-2xl font-bold text-white focus:ring-2 focus:ring-green-500/50 outline-none transition-all placeholder-zinc-700"
                            placeholder="0"
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="text-xs font-bold text-zinc-500 tracking-wider uppercase mb-2 block">Payment Mode</label>
                            <div className="relative">
                                <select 
                                    value={paymentForm.mode}
                                    onChange={e => setPaymentForm({...paymentForm, mode: e.target.value})}
                                    className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white appearance-none focus:ring-2 focus:ring-indigo-500 outline-none [&>option]:bg-zinc-900"
                                >
                                    <option value="CASH">Cash</option>
                                    <option value="UPI">UPI / Online</option>
                                    <option value="CHEQUE">Cheque</option>
                                </select>
                                <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 pointer-events-none" size={16} />
                            </div>
                        </div>
                        <div>
                            <label className="text-xs font-bold text-zinc-500 tracking-wider uppercase mb-2 block">Date</label>
                            <input 
                                type="date"
                                value={paymentForm.date}
                                onChange={e => setPaymentForm({...paymentForm, date: e.target.value})}
                                className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none [color-scheme:dark]"
                            />
                        </div>
                    </div>

                    <div>
                        <label className="text-xs font-bold text-zinc-500 tracking-wider uppercase mb-2 block">Transaction ID (Optional)</label>
                        <input 
                            type="text" 
                            value={paymentForm.transactionId}
                            onChange={e => setPaymentForm({...paymentForm, transactionId: e.target.value})}
                            className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:ring-2 focus:ring-indigo-500 outline-none placeholder-zinc-600"
                            placeholder="e.g. TXN-123456789"
                        />
                    </div>

                    <button 
                        type="submit" 
                        className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-900/20 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 text-lg"
                    >
                        <CheckCircle size={24} />
                        Confirm Payment
                    </button>
                </form>
            </div>
        </div>
      )}

      {/* Receipt Modal */}
      {showReceipt && (
          <div className="fixed inset-0 bg-black/90 flex items-center justify-center z-[60] p-4 backdrop-blur-md">
              <div className="print-container bg-white text-black rounded-xl max-w-sm w-full overflow-hidden">
                  <div className="receipt-content bg-white">
                      <div className="p-6 text-center border-b border-dashed border-gray-300">
                          <h2 className="text-2xl font-bold">Udaan Vidhyalay</h2>
                          <p className="text-xs uppercase tracking-widest text-gray-500">Payment Receipt</p>
                      </div>
                      <div className="p-6 space-y-3 text-sm">
                          <div className="flex justify-between"><span className="text-gray-500">Receipt No</span><span className="font-mono">{showReceipt.id}</span></div>
                          <div className="flex justify-between"><span className="text-gray-500">Date</span><span>{showReceipt.date}</span></div>
                          <div className="border-t border-dashed border-gray-200 my-2"></div>
                          <div className="font-bold text-lg">{receiptStudent.fullName}</div>
                          <div className="text-gray-600">Class {receiptStudent.className} - {receiptStudent.section}</div>
                          <div className="bg-gray-100 p-3 rounded flex justify-between mt-2"><span className="font-medium">Amount Paid</span><span className="font-bold">₹{showReceipt.amount}</span></div>
                          <div className="flex justify-between text-xs text-gray-500 mt-1"><span>Mode: {showReceipt.type}</span><span>Sem: {showReceipt.semester}</span></div>
                      </div>
                  </div>
                  <div className="bg-gray-900 p-4 flex justify-center gap-2 no-print flex-wrap">
                      <button onClick={()=>window.print()} className="flex items-center gap-2 px-3 py-2 bg-white text-black rounded font-bold text-xs"><Printer size={14}/> Print</button>
                      <button onClick={handleDownloadReceipt} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded font-bold text-xs"><FileImage size={14}/> Download</button>
                      <button onClick={()=>setShowReceipt(null)} className="px-3 py-2 text-white border border-white/20 rounded text-xs">Close</button>
                  </div>
              </div>
          </div>
      )}
    </div>
  );
};

// --- ATTENDANCE MANAGER ---
const AttendanceManager = () => {
  const [students, setStudents] = useState([]);
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [attendanceMap, setAttendanceMap] = useState({});
  const [aiAnalysis, setAiAnalysis] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [filterClass, setFilterClass] = useState('');
  const [filterSection, setFilterSection] = useState('');

  useEffect(() => { setStudents(db.getStudents()); loadAttendanceForDate(selectedDate); }, [selectedDate]);
  
  const loadAttendanceForDate = (date) => {
    const records = db.getAttendance().filter(r => r.date === date);
    const map = {}; records.forEach(r => map[r.studentId] = r.status);
    setAttendanceMap(map);
  };

  const updateStatus = (studentId, status) => {
    setAttendanceMap(prev => ({ ...prev, [studentId]: status }));
    const existing = db.getAttendance().find(r => r.studentId === studentId && r.date === selectedDate);
    db.saveAttendance({ id: existing ? existing.id : `${studentId}-${selectedDate}`, studentId, date: selectedDate, status });
  };

  const filteredStudents = students.filter(s => {
      const matchesClass = filterClass ? String(s.className) === String(filterClass) : true;
      const matchesSection = filterSection ? s.section === filterSection : true;
      return matchesClass && matchesSection;
  });

  const markAll = (status) => {
      filteredStudents.forEach(s => updateStatus(s.id, status));
  };

  const handleAnalyze = async () => {
      setIsAnalyzing(true);
      setAiAnalysis(await generateAttendanceAnalysis(db.getAttendance(), students.length));
      setIsAnalyzing(false);
  };

  return (
    <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col">
      <div className="p-6 border-b border-white/10 flex flex-wrap gap-4 justify-between items-center">
        <h2 className="text-xl font-bold text-white flex items-center gap-2"><Calendar className="text-indigo-400" /> Attendance</h2>
        <div className="flex gap-2">
            <button onClick={handleAnalyze} className="flex items-center gap-2 bg-purple-600 px-3 py-2 rounded-lg text-sm text-white">{isAnalyzing?'...':'AI Insights'}</button>
            <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="bg-white/5 border border-white/10 rounded-lg p-2 text-white [color-scheme:dark]" />
        </div>
      </div>
      <div className="p-4 bg-white/5 border-b border-white/10 flex flex-wrap gap-4 items-center">
          <select value={filterClass} onChange={e=>setFilterClass(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="">All Classes</option>{[...Array(12)].map((_,i)=><option key={i} value={i+1}>{i+1}</option>)}</select>
          <select value={filterSection} onChange={e=>setFilterSection(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="">All Sections</option>{['A','B','C','D'].map(s=><option key={s} value={s}>{s}</option>)}</select>
          <div className="h-6 w-px bg-white/10 mx-2"></div>
          <button onClick={() => markAll('Present')} className="px-3 py-2 text-xs bg-green-500/20 text-green-300 rounded border border-green-500/20">Mark All Present</button>
          <button onClick={() => markAll('Absent')} className="px-3 py-2 text-xs bg-red-500/20 text-red-300 rounded border border-red-500/20">Mark All Absent</button>
      </div>
      
      {aiAnalysis && <div className="m-4 p-4 bg-purple-900/30 border border-purple-500/30 rounded-xl text-sm text-zinc-200 whitespace-pre-line relative"><button onClick={()=>setAiAnalysis(null)} className="absolute top-2 right-2 text-purple-300"><X size={16}/></button>{aiAnalysis}</div>}

      <div className="overflow-auto flex-1 p-4 custom-scrollbar">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            {students.map(student => {
                const status = attendanceMap[student.id];
                const isHidden = (filterClass && String(student.className) !== String(filterClass)) || (filterSection && student.section !== filterSection);
                if(isHidden) return null;

                return (
                    <div key={student.id} className={`p-4 rounded-lg border backdrop-blur-sm ${status ? 'border-white/10 bg-white/5' : 'border-orange-500/30 bg-orange-500/10'}`}>
                        <div className="mb-3"><h3 className="font-semibold text-zinc-200">{student.fullName}</h3><p className="text-xs text-zinc-400">Class {student.className}-{student.section}</p></div>
                        <div className="flex gap-1 bg-black/20 p-1 rounded-md">
                            {['Present', 'Absent', 'Late', 'Excused'].map(opt => (
                                <button key={opt} onClick={() => updateStatus(student.id, opt)} className={`flex-1 text-[10px] py-1.5 rounded transition-all ${status === opt ? (opt==='Present'?'bg-green-600 text-white':opt==='Absent'?'bg-red-600 text-white':'bg-yellow-600 text-white') : 'text-zinc-500 hover:bg-white/10'}`}>{opt[0]}</button>
                            ))}
                        </div>
                    </div>
                )
            })}
        </div>
      </div>
    </div>
  );
};

// --- EXAM MANAGER ---
const ExamManager = () => {
  const [students, setStudents] = useState([]);
  const [examType, setExamType] = useState('Mid-Term');
  const [subject, setSubject] = useState('Mathematics');
  const [results, setResults] = useState({});
  const [selectedClass, setSelectedClass] = useState('1');
  const [selectedSection, setSelectedSection] = useState('A');
  const [isSaving, setIsSaving] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);

  useEffect(() => { setStudents(db.getStudents()); loadResults(db.getStudents(), examType, subject); }, [examType, subject]);
  
  const loadResults = (list, type, sub) => {
    const all = db.getExams(); const map = {};
    list.forEach(s => { const m = all.find(r => r.studentId === s.id && r.examType === type && r.subject === sub); if(m) map[s.id] = m.marksObtained; });
    setResults(map);
  };

  const handleMarkChange = (id, val) => {
      if (val === '') { const n = {...results}; delete n[id]; setResults(n); return; }
      setResults(prev => ({...prev, [id]: parseFloat(val)})); setSaveSuccess(false);
  };

  const filteredStudents = students.filter(s => String(s.className) === String(selectedClass) && s.section === selectedSection);

  const saveAll = () => {
      setIsSaving(true);
      setTimeout(() => {
        filteredStudents.forEach(s => {
            if (results[s.id] !== undefined) db.saveExamResult({ id: `${s.id}-${examType}-${subject}`, studentId: s.id, subject, examType, marksObtained: results[s.id], totalMarks: 100 });
        });
        setIsSaving(false); setSaveSuccess(true); setTimeout(() => setSaveSuccess(false), 3000);
      }, 600);
  };

  const handleExportResults = () => {
      if(filteredStudents.length === 0) return alert("No students to export");
      const headers = ["Roll,Name,Exam,Subject,Marks"];
      const rows = filteredStudents.map(s => `${s.rollNo},"${s.fullName}",${examType},${subject},${results[s.id] ?? 'N/A'}`);
      const blob = new Blob([headers.concat(rows).join('\n')], { type: 'text/csv' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `results_${selectedClass}${selectedSection}_${subject}.csv`; a.click();
  };

  return (
    <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col">
      <div className="p-6 border-b border-white/10 flex flex-wrap gap-4 justify-between items-center">
        <h2 className="text-xl font-bold flex items-center gap-2"><FileSpreadsheet className="text-indigo-400" /> Exam Results</h2>
        <button onClick={handleExportResults} className="flex items-center gap-2 bg-white/5 border border-white/10 px-4 py-2 rounded-lg text-sm hover:bg-white/10"><Download size={16}/> Export CSV</button>
      </div>
      <div className="p-4 bg-white/5 border-b border-white/10 flex flex-wrap gap-4">
           <select value={selectedClass} onChange={e => setSelectedClass(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900 w-24">{[...Array(12)].map((_, i) => <option key={i} value={i+1}>Class {i+1}</option>)}</select>
           <select value={selectedSection} onChange={e => setSelectedSection(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900 w-20">{['A','B','C','D'].map(s => <option key={s} value={s}>{s}</option>)}</select>
           <div className="w-px bg-white/10 h-8 mx-2 hidden sm:block"></div>
           <select value={examType} onChange={e => setExamType(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900"><option value="Mid-Term">Mid-Term</option><option value="Final">Final</option></select>
           <select value={subject} onChange={e => setSubject(e.target.value)} className="bg-black/20 border border-white/10 rounded-lg p-2 text-white [&>option]:bg-zinc-900">{['Mathematics', 'Science', 'English', 'Social Studies', 'Hindi'].map(s => <option key={s} value={s}>{s}</option>)}</select>
      </div>
      <div className="overflow-auto flex-1 custom-scrollbar">
        <table className="w-full text-left text-sm text-zinc-300">
          <thead className="bg-white/5 sticky top-0 backdrop-blur-md"><tr><th className="p-4">Roll</th><th className="p-4">Name</th><th className="p-4 text-center">Marks (100)</th><th className="p-4 text-center">Grade</th></tr></thead>
          <tbody>
            {filteredStudents.length > 0 ? filteredStudents.map(student => {
                const marks = results[student.id]; const grade = marks >= 90 ? 'A+' : marks >= 80 ? 'A' : marks >= 70 ? 'B' : marks >= 40 ? 'C' : 'F';
                return (
                    <tr key={student.id} className="hover:bg-white/5">
                        <td className="p-4">#{student.rollNo}</td><td className="p-4 font-bold text-white">{student.fullName}</td>
                        <td className="p-4 text-center"><input type="number" value={marks !== undefined ? marks : ''} onChange={e => handleMarkChange(student.id, e.target.value)} className="w-20 p-2 bg-black/20 border border-white/10 rounded text-center outline-none text-white focus:ring-1 focus:ring-indigo-500" placeholder="-"/></td>
                        <td className={`p-4 text-center font-bold ${grade==='F'?'text-red-400':'text-green-400'}`}>{grade}</td>
                    </tr>
                );
            }) : <tr><td colSpan={4} className="p-8 text-center text-zinc-500">No students in selected class.</td></tr>}
          </tbody>
        </table>
      </div>
      <div className="p-4 border-t border-white/10 bg-white/5 flex justify-end">
        <button onClick={saveAll} disabled={isSaving} className={`flex items-center gap-2 px-6 py-2 rounded-lg font-bold transition-all ${saveSuccess ? 'bg-green-600 text-white' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}>
            {isSaving ? <Loader2 size={18} className="animate-spin" /> : saveSuccess ? <Check size={18} /> : <Save size={18} />}
            {isSaving ? 'Saving...' : saveSuccess ? 'Saved!' : 'Save Results'}
        </button>
      </div>
    </div>
  );
};

// --- TEACHER MANAGER ---
const TeacherManager = () => {
    const [teachers, setTeachers] = useState([]);
    const [activeTab, setActiveTab] = useState('LIST');
    const [showForm, setShowForm] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    const [formData, setFormData] = useState({ id: '', fullName: '', email: '', phone: '', subject: '', salary: 0, joinDate: new Date().toISOString().split('T')[0], qualification: '' });
    
    // Attendance states
    const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
    const [attendanceMap, setAttendanceMap] = useState({});

    useEffect(() => { setTeachers(db.getTeachers()); }, []);
    
    useEffect(() => {
        if(activeTab === 'ATTENDANCE') {
            const allRecs = db.getTeacherAttendance();
            const todaysRecs = allRecs.filter(r => r.date === attendanceDate);
            const map = {}; todaysRecs.forEach(r => map[r.teacherId] = r.status);
            setAttendanceMap(map);
        }
    }, [activeTab, attendanceDate]);

    const handleSave = (e) => { 
        e.preventDefault(); 
        db.saveTeacher({...formData, id: formData.id || Date.now().toString()}); 
        setTeachers(db.getTeachers()); 
        setShowForm(false); 
        alert("Teacher Saved!"); 
    };
    
    const handleDelete = (id) => { if(confirm("Delete?")) { db.deleteTeacher(id); setTeachers(db.getTeachers()); } };

    const markAttendance = (teacherId, status) => {
        const record = { id: `${teacherId}-${attendanceDate}`, teacherId, date: attendanceDate, status };
        db.saveTeacherAttendance(record);
        setAttendanceMap(prev => ({...prev, [teacherId]: status}));
    };

    const changeDate = (days) => {
        const d = new Date(attendanceDate); d.setDate(d.getDate() + days);
        setAttendanceDate(d.toISOString().split('T')[0]);
    };

    const filteredTeachers = teachers.filter(t => t.fullName.toLowerCase().includes(searchTerm.toLowerCase()));

    return (
        <div className="bg-black/40 backdrop-blur-xl rounded-xl border border-white/10 h-full flex flex-col">
            <div className="p-6 border-b border-white/10 flex flex-wrap gap-4 justify-between items-center">
                <h2 className="text-xl font-bold">Teacher Management</h2>
                <div className="flex bg-white/5 rounded-lg p-1 border border-white/10">
                    <button onClick={()=>setActiveTab('LIST')} className={`px-4 py-2 rounded-md text-sm font-bold ${activeTab==='LIST'?'bg-white/10 text-indigo-300':'text-zinc-400'}`}>Directory</button>
                    <button onClick={()=>setActiveTab('ATTENDANCE')} className={`px-4 py-2 rounded-md text-sm font-bold ${activeTab==='ATTENDANCE'?'bg-white/10 text-indigo-300':'text-zinc-400'}`}>Attendance</button>
                </div>
            </div>

            <div className="flex-1 overflow-hidden p-4">
                {activeTab === 'LIST' && (
                    <div className="h-full flex flex-col">
                        <div className="flex justify-between mb-4 gap-4">
                            <div className="relative flex-1 max-w-sm">
                                <Search className="absolute left-3 top-2.5 text-zinc-500" size={16}/>
                                <input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search teachers..." className="w-full pl-9 pr-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white outline-none"/>
                            </div>
                            <button onClick={()=>{setShowForm(true); setFormData({id:Date.now().toString(), fullName:'', subject:'', salary:0, email:'', phone:'', joinDate: new Date().toISOString().split('T')[0], qualification:'' })}} className="bg-indigo-600 px-4 py-2 rounded-lg text-white text-sm font-bold flex items-center gap-2"><UserPlus size={16}/> Add Teacher</button>
                        </div>
                        
                        {showForm && (
                             <div className="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
                                <form onSubmit={handleSave} className="bg-zinc-900 p-6 rounded-xl w-full max-w-lg space-y-4 border border-white/10">
                                    <h3 className="font-bold text-lg">Teacher Details</h3>
                                    <input className="w-full p-2 bg-white/5 rounded border border-white/10 text-white" placeholder="Name" value={formData.fullName} onChange={e=>setFormData({...formData, fullName:e.target.value})} required/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="w-full p-2 bg-white/5 rounded border border-white/10 text-white" placeholder="Subject" value={formData.subject} onChange={e=>setFormData({...formData, subject:e.target.value})} required/>
                                        <input className="w-full p-2 bg-white/5 rounded border border-white/10 text-white" placeholder="Qualification" value={formData.qualification} onChange={e=>setFormData({...formData, qualification:e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input className="w-full p-2 bg-white/5 rounded border border-white/10 text-white" placeholder="Phone" value={formData.phone} onChange={e=>setFormData({...formData, phone:e.target.value})}/>
                                        <input className="w-full p-2 bg-white/5 rounded border border-white/10 text-white" placeholder="Email" value={formData.email} onChange={e=>setFormData({...formData, email:e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input type="number" className="w-full p-2 bg-white/5 rounded border border-white/10 text-white" placeholder="Salary" value={formData.salary} onChange={e=>setFormData({...formData, salary:Number(e.target.value)})} required/>
                                        <input type="date" className="w-full p-2 bg-white/5 rounded border border-white/10 text-white [color-scheme:dark]" value={formData.joinDate} onChange={e=>setFormData({...formData, joinDate:e.target.value})}/>
                                    </div>
                                    <div className="flex gap-2 pt-2"><button type="button" onClick={()=>setShowForm(false)} className="flex-1 py-2 border border-white/10 rounded text-zinc-400">Cancel</button><button type="submit" className="flex-1 py-2 bg-indigo-600 rounded text-white font-bold">Save</button></div>
                                </form>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-auto custom-scrollbar flex-1 pb-4">
                            {filteredTeachers.map(t => (
                                <div key={t.id} className="p-4 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition group">
                                    <div className="flex justify-between items-start">
                                        <div><div className="font-bold text-white">{t.fullName}</div><div className="text-xs text-indigo-300">{t.subject}</div></div>
                                        <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition"><button onClick={()=>{setFormData(t); setShowForm(true);}} className="text-blue-400 p-1"><Edit size={16}/></button><button onClick={()=>handleDelete(t.id)} className="text-red-400 p-1"><Trash2 size={16}/></button></div>
                                    </div>
                                    <div className="mt-3 space-y-1 text-xs text-zinc-400">
                                        <div className="flex gap-2"><Phone size={12}/> {t.phone||'N/A'}</div>
                                        <div className="flex gap-2"><Mail size={12}/> {t.email||'N/A'}</div>
                                        <div className="flex gap-2 font-bold text-zinc-300"><IndianRupee size={12}/> ₹{t.salary}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                {activeTab === 'ATTENDANCE' && (
                    <div className="h-full flex flex-col">
                         <div className="flex items-center gap-4 mb-4 bg-white/5 p-3 rounded-lg border border-white/10">
                             <button onClick={()=>changeDate(-1)} className="p-1 hover:bg-white/10 rounded"><ChevronLeft size={20}/></button>
                             <div className="flex items-center gap-2 font-bold text-lg"><Calendar size={20} className="text-indigo-400"/> {attendanceDate}</div>
                             <button onClick={()=>changeDate(1)} className="p-1 hover:bg-white/10 rounded"><ChevronRight size={20}/></button>
                             <div className="ml-auto flex gap-3 text-xs font-bold">
                                 <div className="px-3 py-1 bg-green-500/20 text-green-300 rounded border border-green-500/20">Present: {Object.values(attendanceMap).filter(v=>v==='Present').length}</div>
                                 <div className="px-3 py-1 bg-red-500/20 text-red-300 rounded border border-red-500/20">Absent: {Object.values(attendanceMap).filter(v=>v==='Absent').length}</div>
                             </div>
                         </div>
                         <div className="overflow-auto custom-scrollbar flex-1 rounded-lg border border-white/10">
                             <table className="w-full text-left text-sm text-zinc-300">
                                 <thead className="bg-white/5 sticky top-0 backdrop-blur-md"><tr><th className="p-4">Teacher</th><th className="p-4">Subject</th><th className="p-4 text-center">Status</th><th className="p-4 text-right">Action</th></tr></thead>
                                 <tbody>
                                     {teachers.map(t => (
                                         <tr key={t.id} className="border-b border-white/5 hover:bg-white/5">
                                             <td className="p-4 font-medium text-white">{t.fullName}</td>
                                             <td className="p-4 text-xs">{t.subject}</td>
                                             <td className="p-4 text-center">{attendanceMap[t.id]==='Present' ? <span className="text-green-400 font-bold flex items-center justify-center gap-1"><CheckCircle size={14}/> Present</span> : attendanceMap[t.id]==='Absent' ? <span className="text-red-400 font-bold flex items-center justify-center gap-1"><XCircle size={14}/> Absent</span> : <span className="text-zinc-600">-</span>}</td>
                                             <td className="p-4 text-right">
                                                 <div className="flex justify-end gap-2">
                                                     <button onClick={()=>markAttendance(t.id, 'Present')} className={`px-3 py-1 rounded text-xs font-bold ${attendanceMap[t.id]==='Present'?'bg-green-600 text-white':'bg-white/10 hover:text-green-400'}`}>Present</button>
                                                     <button onClick={()=>markAttendance(t.id, 'Absent')} className={`px-3 py-1 rounded text-xs font-bold ${attendanceMap[t.id]==='Absent'?'bg-red-600 text-white':'bg-white/10 hover:text-red-400'}`}>Absent</button>
                                                 </div>
                                             </td>
                                         </tr>
                                     ))}
                                 </tbody>
                             </table>
                         </div>
                    </div>
                )}
            </div>
        </div>
    )
};

const DashboardHome = ({ stats, onNavigate }) => {
    const pieData = [{ name: 'Boys', value: stats.genderStats?.male || 0 }, { name: 'Girls', value: stats.genderStats?.female || 0 }];
    const COLORS = ['#6366f1', '#ec4899'];
    const Stat = ({title, val, icon: I, col}) => <div className="p-6 bg-black/40 border border-white/10 rounded-xl flex items-center gap-4"><div className={`p-3 rounded-lg text-white ${col}`}><I size={24}/></div><div><div className="text-zinc-400 text-sm">{title}</div><div className="text-2xl font-bold">{val}</div></div></div>;
    return (
        <div className="space-y-6 overflow-y-auto h-full pb-20 custom-scrollbar">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <Stat title="Total Students" val={stats.totalStudents} icon={Users} col="bg-indigo-600"/>
                <Stat title="Total Teachers" val={stats.totalTeachers} icon={GraduationCap} col="bg-teal-600"/>
                <Stat title="Fees Collected" val={`₹${stats.totalRevenue}`} icon={IndianRupee} col="bg-green-600"/>
                <Stat title="Pass Rate" val={`${stats.passPercentage}%`} icon={Award} col="bg-purple-600"/>
            </div>
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                 <div className="lg:col-span-2 bg-black/40 border border-white/10 rounded-xl p-6">
                     <h3 className="font-bold mb-4">Shortcuts</h3>
                     <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                         {[
                             {l:'Add Student', i:Users, v:View.STUDENTS}, {l:'Teachers', i:GraduationCap, v:View.TEACHERS}, {l:'Attendance', i:CheckSquare, v:View.ATTENDANCE},
                             {l:'Fees', i:IndianRupee, v:View.FEES}, {l:'Results', i:FileSpreadsheet, v:View.EXAMS}
                         ].map(x => (
                             <button key={x.l} onClick={()=>onNavigate(x.v)} className="p-4 bg-white/5 rounded-lg hover:bg-white/10 flex flex-col items-center gap-2 border border-white/5">
                                 <x.i size={24} className="text-indigo-400"/>
                                 <span className="text-sm font-medium">{x.l}</span>
                             </button>
                         ))}
                     </div>
                 </div>
                 <div className="bg-black/40 border border-white/10 rounded-xl p-6 flex flex-col">
                     <h3 className="font-bold mb-2">Demographics</h3>
                     <div className="w-full h-[200px]">
                         <ResponsiveContainer width="100%" height="100%"><RePieChart><Pie data={pieData} innerRadius={50} outerRadius={70} dataKey="value" stroke="none">{pieData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}</Pie><Tooltip/></RePieChart></ResponsiveContainer>
                     </div>
                 </div>
            </div>
        </div>
    );
};

const Dashboard = ({ onLogout, user }) => {
  const [currentView, setCurrentView] = useState(View.DASHBOARD);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [stats, setStats] = useState({ totalStudents: 0, totalTeachers: 0, totalRevenue: 0, passPercentage: 0, genderStats: { male: 0, female: 0 } });
  
  useEffect(() => {
      db.initializeData();
      const update = () => {
          const s = db.getStudents(); const f = db.getFees(); const e = db.getExams();
          const rev = f.reduce((a,c) => a + (c.semester1Paid?11000:0) + (c.semester2Paid?11000:0), 0);
          const passed = e.filter(x => x.marksObtained >= 40).length;
          setStats({
              totalStudents: s.length, totalTeachers: db.getTeacherCount(), totalRevenue: rev,
              passPercentage: e.length ? Math.round((passed/e.length)*100) : 0,
              genderStats: { male: s.filter(x=>x.gender==='Male').length, female: s.filter(x=>x.gender==='Female').length }
          });
      };
      update(); const i = setInterval(update, 2000); return () => clearInterval(i);
  }, []);

  const renderContent = () => {
    switch (currentView) {
      case View.STUDENTS: return <StudentManager />;
      case View.TEACHERS: return <TeacherManager />;
      case View.FEES: return <FeesManager />;
      case View.ATTENDANCE: return <AttendanceManager />;
      case View.EXAMS: return <ExamManager />;
      default: return <DashboardHome stats={stats} onNavigate={setCurrentView} />;
    }
  };

  return (
    <div className="flex min-h-screen bg-transparent text-zinc-100">
      <Sidebar currentView={currentView} onChangeView={setCurrentView} onLogout={onLogout} isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} user={user}/>
      <main className="flex-1 p-4 md:p-8 overflow-hidden h-screen flex flex-col md:ml-64 transition-all">
        <header className="flex justify-between items-center mb-6 shrink-0">
             <div className="flex items-center gap-4">
                <button onClick={() => setIsSidebarOpen(true)} className="md:hidden p-2 hover:bg-white/10 rounded-lg"><Menu size={24} /></button>
                <div className="flex flex-col">
                    <h1 className="text-xl md:text-2xl font-bold">{currentView === View.DASHBOARD ? 'Overview' : currentView}</h1>
                    <span className="text-xs text-zinc-400 hidden sm:block">Welcome back, {user?.name || 'Admin'}</span>
                </div>
             </div>
             <div className="flex items-center gap-3">
                 <div className="text-sm bg-black/30 px-4 py-2 rounded-full border border-white/10 hidden sm:block">{new Date().toDateString()}</div>
                 {user?.avatar && <img src={user.avatar} className="w-8 h-8 rounded-full border border-white/20 sm:hidden" />}
             </div>
        </header>
        <div className="flex-1 overflow-hidden relative">{renderContent()}</div>
      </main>
    </div>
  );
};

const App = () => {
  const [user, setUser] = useState(null);

  useEffect(() => { 
      const stored = sessionStorage.getItem('uv_user');
      if (stored) setUser(JSON.parse(stored));
  }, []);

  const login = (userData) => { 
      sessionStorage.setItem('uv_user', JSON.stringify(userData)); 
      setUser(userData); 
  };
  
  const logout = () => { 
      sessionStorage.removeItem('uv_user'); 
      setUser(null); 
  };

  return user ? <Dashboard onLogout={logout} user={user} /> : <Login onLogin={login} />;
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Udaan Vidhyalay - School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Babel for on-the-fly JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(-45deg, #0f172a, #312e81, #581c87, #831843, #1e1b4b);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        color: #f4f4f5;
        min-height: 100vh;
      }

      @keyframes gradientBG {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
      ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }
      
      .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    </style>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.4.1",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-type="module" data-presets="env,react,typescript">
import React, { useState, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";
import { 
  ShieldCheck, LayoutDashboard, Users, Banknote, CheckSquare, FileSpreadsheet, LogOut, School, GraduationCap, X,
  Plus, Trash2, Edit, Save, Wand2, AlertCircle, Calendar, Download, Filter, CopyPlus, RotateCcw, Search, Lock, Sparkles,
  CheckCircle, XCircle, History, ChevronDown, ChevronUp, Printer, CreditCard, Wallet, Receipt,
  BrainCircuit, UserPlus, IndianRupee, Phone, Mail, ChevronLeft, ChevronRight, Award, PieChart, Menu
} from 'lucide-react';
import { PieChart as RePieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

// --- TYPES ---
enum View {
  DASHBOARD = 'DASHBOARD',
  STUDENTS = 'STUDENTS',
  TEACHERS = 'TEACHERS',
  FEES = 'FEES',
  ATTENDANCE = 'ATTENDANCE',
  EXAMS = 'EXAMS',
  SETTINGS = 'SETTINGS'
}

interface Student {
  id: string;
  rollNo: number;
  fullName: string;
  gender: 'Male' | 'Female' | 'Other';
  dateOfBirth: string;
  contactNumber: string;
  address: string;
  className: string;
  section: string;
  admissionDate: string;
}

interface Teacher {
  id: string;
  fullName: string;
  email: string;
  subject: string;
  qualification: string;
  phone: string;
  salary: number;
  joinDate: string;
}

interface TeacherAttendance {
  id: string;
  teacherId: string;
  date: string;
  status: 'Present' | 'Absent';
}

interface Transaction {
  id: string;
  date: string;
  amount: number;
  type: 'UPI' | 'CASH' | 'ONLINE';
  semester: 1 | 2;
}

interface FeeRecord {
  id: string;
  studentId: string;
  academicYear: string;
  semester1Paid: boolean;
  semester2Paid: boolean;
  lastPaymentDate?: string;
  transactions?: Transaction[];
}

interface AttendanceRecord {
  id: string;
  studentId: string;
  date: string;
  status: 'Present' | 'Absent' | 'Late' | 'Excused';
}

interface ExamResult {
  id: string;
  studentId: string;
  subject: string;
  marksObtained: number;
  totalMarks: number;
  examType: 'Mid-Term' | 'Final';
}

// --- DB SERVICE ---
const STORAGE_KEYS = {
  STUDENTS: 'uv_students_v1',
  TEACHERS: 'uv_teachers_v1',
  TEACHER_ATTENDANCE: 'uv_teacher_attendance_v1',
  FEES: 'uv_fees_v1',
  ATTENDANCE: 'uv_attendance_v1',
  EXAMS: 'uv_exams_v1',
};

class DatabaseService {
  // --- Teachers ---
  getTeachers() {
    const data = localStorage.getItem(STORAGE_KEYS.TEACHERS);
    return data ? JSON.parse(data) : [];
  }

  saveTeacher(teacher) {
    const teachers = this.getTeachers();
    const existingIndex = teachers.findIndex(t => t.id === teacher.id);
    
    if (existingIndex >= 0) {
      teachers[existingIndex] = teacher;
    } else {
      teachers.push(teacher);
    }
    
    localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify(teachers));
  }

  deleteTeacher(id) {
    const teachers = this.getTeachers().filter(t => t.id !== id);
    localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify(teachers));
  }

  getTeacherAttendance() {
    const data = localStorage.getItem(STORAGE_KEYS.TEACHER_ATTENDANCE);
    return data ? JSON.parse(data) : [];
  }

  saveTeacherAttendance(record) {
    const data = this.getTeacherAttendance();
    const index = data.findIndex(d => d.id === record.id);
    if (index >= 0) data[index] = record;
    else data.push(record);
    localStorage.setItem(STORAGE_KEYS.TEACHER_ATTENDANCE, JSON.stringify(data));
  }

  getTeacherCount() {
    return this.getTeachers().length;
  }

  // --- Students ---
  getStudents() {
    const data = localStorage.getItem(STORAGE_KEYS.STUDENTS);
    return data ? JSON.parse(data) : [];
  }

  saveStudent(student) {
    const students = this.getStudents();
    const existingIndex = students.findIndex(s => s.id === student.id);
    
    if (existingIndex >= 0) {
      students[existingIndex] = student;
    } else {
      students.push(student);
    }
    
    localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
  }

  deleteStudent(id) {
    const students = this.getStudents().filter(s => s.id !== id);
    localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
    
    // Cleanup related records
    this.cleanupRelatedRecords(id);
  }

  cleanupRelatedRecords(studentId) {
    // Fees
    const fees = this.getFees().filter(f => f.studentId !== studentId);
    localStorage.setItem(STORAGE_KEYS.FEES, JSON.stringify(fees));
    // Attendance
    const att = this.getAttendance().filter(a => a.studentId !== studentId);
    localStorage.setItem(STORAGE_KEYS.ATTENDANCE, JSON.stringify(att));
    // Exams
    const exams = this.getExams().filter(e => e.studentId !== studentId);
    localStorage.setItem(STORAGE_KEYS.EXAMS, JSON.stringify(exams));
  }

  getNextRollNo() {
    const students = this.getStudents();
    if (students.length === 0) return 1001;
    const maxRoll = Math.max(...students.map(s => s.rollNo));
    return maxRoll + 1;
  }

  // --- Fees ---
  getFees() {
    const data = localStorage.getItem(STORAGE_KEYS.FEES);
    return data ? JSON.parse(data) : [];
  }

  saveFeeRecord(record) {
    const fees = this.getFees();
    const index = fees.findIndex(f => f.id === record.id);
    if (index >= 0) fees[index] = record;
    else fees.push(record);
    localStorage.setItem(STORAGE_KEYS.FEES, JSON.stringify(fees));
  }

  // --- Attendance ---
  getAttendance() {
    const data = localStorage.getItem(STORAGE_KEYS.ATTENDANCE);
    return data ? JSON.parse(data) : [];
  }

  saveAttendance(record) {
    const data = this.getAttendance();
    const index = data.findIndex(d => d.id === record.id);
    if (index >= 0) data[index] = record;
    else data.push(record);
    localStorage.setItem(STORAGE_KEYS.ATTENDANCE, JSON.stringify(data));
  }

  // --- Exams ---
  getExams() {
    const data = localStorage.getItem(STORAGE_KEYS.EXAMS);
    return data ? JSON.parse(data) : [];
  }

  saveExamResult(result) {
    const data = this.getExams();
    const index = data.findIndex(d => d.id === result.id);
    if (index >= 0) data[index] = result;
    else data.push(result);
    localStorage.setItem(STORAGE_KEYS.EXAMS, JSON.stringify(data));
  }

  // Initialize fake data if empty
  initializeData() {
    if (!localStorage.getItem(STORAGE_KEYS.STUDENTS)) {
        localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify([]));
    }
    
    if (!localStorage.getItem(STORAGE_KEYS.TEACHERS)) {
        localStorage.setItem(STORAGE_KEYS.TEACHERS, JSON.stringify([]));
    }
  }
}

const db = new DatabaseService();

// --- GEMINI SERVICE ---
const getClient = () => {
    let apiKey = '';
    try {
        if (typeof process !== 'undefined' && process.env) {
            apiKey = process.env.API_KEY || '';
        }
    } catch (e) {
        console.warn("Environment variable access failed", e);
    }

    if (!apiKey) return null;
    return new GoogleGenAI({ apiKey });
}

const generateStudentReport = async (student, exams, attendance) => {
    const client = getClient();
    if (!client) return "API Key is missing. Please configure the environment.";

    const prompt = `
    You are an expert academic counselor for 'Udaan Vidhyalay'.
    Analyze the following student data and write a professional, encouraging, but honest 1-paragraph performance summary for their report card.
    
    Student: ${student.fullName} (Class: ${student.className}-${student.section})
    
    Academic Performance:
    ${exams.map(e => `- ${e.subject} (${e.examType}): ${e.marksObtained}/${e.totalMarks}`).join('\n')}
    
    Attendance Records: ${attendance.length} records found.
    (Assume general attendance is good unless specified otherwise).

    The summary should mention their strengths based on high marks and areas for improvement based on low marks.
    `;

    try {
        const response = await client.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
        });
        return response.text || "No report generated.";
    } catch (error) {
        console.error("Gemini Error:", error);
        return "Error communicating with AI service. Please try again later.";
    }
};

const generateAttendanceAnalysis = async (records, totalStudents) => {
    const client = getClient();
    if (!client) return "API Key is missing.";

    const presentCount = records.filter(r => r.status === 'Present').length;
    const absentCount = records.filter(r => r.status === 'Absent').length;
    const lateCount = records.filter(r => r.status === 'Late').length;

    const dateMap = {};
    records.forEach(r => {
        if(!dateMap[r.date]) dateMap[r.date] = { P: 0, A: 0 };
        if(r.status === 'Present') dateMap[r.date].P++;
        if(r.status === 'Absent') dateMap[r.date].A++;
    });

    const prompt = `
    You are a school administrator analyst. Analyze the following attendance data for 'Udaan Vidhyalay'.
    
    Total Records Scanned: ${records.length}
    Total Students in DB: ${totalStudents}
    
    Summary:
    - Present: ${presentCount}
    - Absent: ${absentCount}
    - Late: ${lateCount}
    
    Daily Breakdown (Sample):
    ${JSON.stringify(Object.entries(dateMap).slice(0, 5))}
    
    Please provide a 3-bullet point analysis:
    1. Overall Attendance Health (Excellent/Good/Poor).
    2. A specific observation (e.g., "High absenteeism observed on...").
    3. One actionable suggestion for improvement.
    Keep it concise and professional.
    `;

    try {
        const response = await client.models.generateContent({
            model: "gemini-2.5-flash",
            contents: prompt,
        });
        return response.text || "Analysis failed.";
    } catch (error) {
        return "Error generating AI analysis.";
    }
}

// --- COMPONENTS ---

// 1. LOGIN
const Login = ({ onLogin }) => {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');

  const handleLogin = (e) => {
    e.preventDefault();
    if (username === 'admin' && password === '1234') {
      onLogin();
    } else {
      setError('Invalid Credentials');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center relative overflow-hidden p-4">
      <div className="bg-black/40 backdrop-blur-xl border border-white/10 p-8 rounded-2xl shadow-2xl w-full max-w-md z-10">
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-indigo-500/20 text-indigo-300 mb-4 border border-indigo-500/30 shadow-inner">
            <ShieldCheck size={32} />
          </div>
          <h1 className="text-3xl font-bold text-white tracking-tight">Udaan Vidhyalay</h1>
          <p className="text-zinc-300 mt-2 font-light">School Management Software</p>
        </div>

        <form onSubmit={handleLogin} className="space-y-6" autoComplete="off">
          <div>
            <label className="block text-sm font-medium text-zinc-300 mb-2">Admin ID</label>
            <input
                type="text"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className="block w-full px-4 py-3 border border-white/10 rounded-lg leading-5 bg-white/5 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm transition duration-150 ease-in-out"
                placeholder="Enter Admin ID"
                autoComplete="off"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-zinc-300 mb-2">Password</label>
            <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                className="block w-full px-4 py-3 border border-white/10 rounded-lg leading-5 bg-white/5 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent sm:text-sm transition duration-150 ease-in-out"
                placeholder="Enter Password"
                autoComplete="new-password"
            />
          </div>

          {error && (
            <div className="bg-red-500/20 text-red-200 text-sm p-3 rounded-md text-center border border-red-500/30 backdrop-blur-sm">
              {error}
            </div>
          )}

          <button
            type="submit"
            className="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded-lg text-white bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 shadow-lg transition-all transform hover:scale-[1.02]"
          >
            Secure Login
          </button>
        </form>
      </div>
    </div>
  );
};

// 2. SIDEBAR
const Sidebar = ({ currentView, onChangeView, onLogout, isOpen, onClose }) => {
  const menuItems = [
    { id: View.DASHBOARD, label: 'Dashboard', icon: LayoutDashboard },
    { id: View.STUDENTS, label: 'Students', icon: Users },
    { id: View.TEACHERS, label: 'Teachers', icon: GraduationCap },
    { id: View.FEES, label: 'Fees Management', icon: Banknote },
    { id: View.ATTENDANCE, label: 'Attendance', icon: CheckSquare },
    { id: View.EXAMS, label: 'Exam Results', icon: FileSpreadsheet },
  ];

  const handleNavigation = (view) => {
    onChangeView(view);
    onClose(); 
  };

  return (
    <>
      {isOpen && (
        <div 
            className="fixed inset-0 bg-black/60 z-30 md:hidden backdrop-blur-sm transition-opacity"
            onClick={onClose}
        />
      )}

      <div className={`
        fixed top-0 left-0 h-full w-64 bg-black/40 backdrop-blur-2xl border-r border-white/10 text-white shadow-2xl z-40 
        transition-transform duration-300 ease-in-out transform 
        ${isOpen ? 'translate-x-0' : '-translate-x-full'} 
        md:translate-x-0 md:z-20
      `}>
        <div className="p-6 border-b border-white/10 flex items-center justify-between gap-3">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-900/40">
                <School size={24} className="text-white" />
            </div>
            <div>
                <h2 className="font-bold text-lg leading-tight">Udaan</h2>
                <span className="text-xs text-zinc-400 uppercase tracking-wider">Vidhyalay</span>
            </div>
          </div>
          <button onClick={onClose} className="md:hidden text-zinc-400 hover:text-white transition-colors">
            <X size={24} />
          </button>
        </div>

        <nav className="flex-1 overflow-y-auto py-6 px-3 space-y-1 custom-scrollbar">
          {menuItems.map((item) => {
              const isActive = currentView === item.id;
              return (
                  <button
                      key={item.id}
                      onClick={() => handleNavigation(item.id)}
                      className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 ${
                          isActive 
                          ? 'bg-indigo-600/80 text-white shadow-lg shadow-indigo-900/20 backdrop-blur-sm' 
                          : 'text-zinc-400 hover:bg-white/10 hover:text-white'
                      }`}
                  >
                      <item.icon size={20} />
                      <span className="font-medium">{item.label}</span>
                  </button>
              );
          })}
        </nav>

        <div className="p-4 border-t border-white/10">
          <button
            onClick={onLogout}
            className="w-full flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition-colors"
          >
            <LogOut size={20} />
            <span className="font-medium">Logout</span>
          </button>
        </div>
      </div>
    </>
  );
};

// 3. STUDENT MANAGER HELPERS & COMPONENT
const CustomDatePicker = ({ label, value, onChange, error, touched }) => {
    return (
        <div className="relative">
            <label className="block text-sm font-medium text-zinc-300 mb-1">
                {label} <span className="text-red-500">*</span>
            </label>
            <div className={`relative flex items-center w-full border rounded-lg bg-white/5 backdrop-blur-sm transition-all duration-200 ${touched && error ? 'border-red-500/50 ring-1 ring-red-500/20' : 'border-white/10 focus-within:ring-2 focus-within:ring-indigo-500 focus-within:border-transparent'}`}>
                <input 
                    type="date" 
                    value={value} 
                    onChange={(e) => onChange(e.target.value)}
                    className="w-full p-3 pl-3 pr-10 outline-none text-zinc-100 rounded-lg bg-transparent text-sm font-medium [color-scheme:dark]"
                />
                <Calendar size={18} className={`absolute right-3 pointer-events-none transition-colors ${touched && error ? 'text-red-400' : 'text-zinc-500'}`} />
            </div>
            {touched && error && (
                <div className="flex items-center gap-1 mt-1.5 text-red-400 text-xs font-medium animate-in slide-in-from-top-1 duration-200">
                    <AlertCircle size={12} />
                    <span>{error}</span>
                </div>
            )}
        </div>
    );
}

const FormField = ({ label, name, value, error, touched, onChange, onBlur, type = "text", placeholder, options, disabled = false }) => {
    const isError = touched && error;
    const inputClasses = `w-full p-3 border rounded-lg focus:ring-2 outline-none bg-white/5 backdrop-blur-sm text-zinc-100 transition-all duration-200 
        ${disabled ? 'opacity-60 cursor-not-allowed bg-white/10 pr-10' : ''}
        ${isError 
          ? 'border-red-500/50 focus:ring-red-500/20 focus:border-red-500' 
          : 'border-white/10 focus:ring-indigo-500 focus:border-transparent hover:border-white/20'}`;
    
    const isWide = name === 'address' || name === 'fullName';

    return (
      <div className={isWide ? 'col-span-2' : ''}>
          <label className="block text-sm font-medium text-zinc-300 mb-1">
              {label} <span className="text-red-500">*</span>
          </label>
          
          <div className="relative">
            {options ? (
                <select 
                    name={name}
                    value={value} 
                    onChange={(e) => onChange(name, e.target.value)}
                    onBlur={() => onBlur(name)}
                    className={`${inputClasses} appearance-none`}
                    disabled={disabled}
                >
                    <option value="" className="bg-zinc-900">Select {label}</option>
                    {options.map((opt) => (
                        <option key={opt.value} value={opt.value} className="bg-zinc-900">{opt.label}</option>
                    ))}
                </select>
            ) : name === 'address' ? (
                <textarea 
                    name={name}
                    rows={3}
                    value={value}
                    onChange={(e) => onChange(name, e.target.value)}
                    onBlur={() => onBlur(name)}
                    className={inputClasses}
                    placeholder={placeholder}
                    disabled={disabled}
                />
            ) : (
                <input 
                    type={type}
                    name={name}
                    value={value}
                    onChange={(e) => onChange(name, e.target.value)}
                    onBlur={() => onBlur(name)}
                    className={inputClasses}
                    placeholder={placeholder}
                    disabled={disabled}
                />
            )}
            {disabled && (
                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-zinc-500 pointer-events-none" title="Auto-generated / Read-only">
                    <Lock size={16} />
                </div>
            )}
          </div>
          
          {isError && (
              <div className="flex items-center gap-1 mt-1.5 text-red-400 text-xs font-medium animate-in slide-in-from-top-1 duration-200">
                  <AlertCircle size={12} />
                  <span>{error}</span>
              </div>
          )}
      </div>
    );
};

const StudentManager = () => {
  const [students, setStudents] = useState([]);
  const [viewMode, setViewMode] = useState('LIST');
  const [searchTerm, setSearchTerm] = useState('');
  const [filterClass, setFilterClass] = useState('');
  const [filterSection, setFilterSection] = useState('');
  const [isEdit, setIsEdit] = useState(false);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiReport, setAiReport] = useState(null);
  const [errors, setErrors] = useState({});
  const [touched, setTouched] = useState({});
  const [formError, setFormError] = useState(null);
  const [saveAction, setSaveAction] = useState('SAVE');

  const initialFormState = {
    id: '',
    rollNo: 0,
    fullName: '',
    gender: 'Male',
    dateOfBirth: '',
    contactNumber: '',
    address: '',
    className: '',
    section: '',
    admissionDate: new Date().toISOString().split('T')[0]
  };
  const [formData, setFormData] = useState(initialFormState);

  useEffect(() => {
    loadStudents();
  }, []);

  const loadStudents = () => {
    setStudents(db.getStudents());
  };

  const resetFormState = () => {
      setErrors({});
      setTouched({});
      setAiReport(null);
      setFormError(null);
  };

  const generateNewCredentials = () => {
    const nextRoll = db.getNextRollNo();
    const year = new Date().getFullYear();
    return {
        id: `UV-${year}-${nextRoll}`,
        rollNo: nextRoll
    };
  };

  const handleAddNew = () => {
    const creds = generateNewCredentials();
    setFormData({ ...initialFormState, ...creds });
    setIsEdit(false);
    resetFormState();
    setViewMode('FORM');
  };

  const handleEdit = (student) => {
    setFormData(student);
    setIsEdit(true);
    resetFormState();
    setViewMode('FORM');
  };

  const handleDelete = (id) => {
    if (window.confirm('Are you sure you want to delete this student? All records will be lost.')) {
      db.deleteStudent(id);
      loadStudents();
    }
  };

  const handleExportCSV = () => {
      if(students.length === 0) {
          alert("No students to export.");
          return;
      }
      const headers = ["ID", "Roll No", "Full Name", "Gender", "DOB", "Contact", "Address", "Class", "Section", "Admission Date"];
      const rows = students.map(s => [s.id, s.rollNo, s.fullName, s.gender, s.dateOfBirth, s.contactNumber, `"${s.address}"`, s.className, s.section, s.admissionDate]);
      
      const csvContent = [
          headers.join(','),
          ...rows.map(r => r.join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.setAttribute('download', `students_export_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  };

  const validateField = (name, value, currentData) => {
    switch (name) {
      case 'id':
        if (!value || !value.toString().trim()) return 'Student ID is required';
        if (!isEdit) {
            const exists = students.some(s => s.id.toLowerCase() === value.toString().toLowerCase());
            if (exists) return 'Student ID already exists';
        }
        return '';
      case 'rollNo':
        if (!value) return 'Roll Number is required';
        if (isNaN(value) || Number(value) <= 0) return 'Enter a valid positive roll number';
        return '';
      case 'fullName':
        if (!value || !value.trim()) return 'Full Name is required';
        if (value.length < 3) return 'Name must be at least 3 characters';
        if (!/^[a-zA-Z\s.]+$/.test(value)) return 'Name can only contain letters, dots, and spaces';
        return '';
      case 'contactNumber':
        if (!value) return 'Contact Number is required';
        if (!/^\d{10}$/.test(value)) return 'Enter a valid 10-digit mobile number';
        return '';
      case 'className':
        if (!value) return 'Class selection is required';
        return '';
      case 'section':
        if (!value) return 'Section selection is required';
        return '';
      case 'gender':
        if (!value) return 'Gender selection is required';
        return '';
      case 'dateOfBirth':
        if (!value) return 'Date of Birth is required';
        const dob = new Date(value);
        const today = new Date();
        if (dob >= today) return 'Date of Birth cannot be in the future';
        return '';
      case 'admissionDate':
        if (!value) return 'Admission Date is required';
        if (currentData.dateOfBirth) {
            const dobDate = new Date(currentData.dateOfBirth);
            const admDate = new Date(value);
            if (admDate <= dobDate) return 'Admission Date must be after Date of Birth';
        }
        return '';
      case 'address':
        if (!value || !value.trim()) return 'Address is required';
        if (value.trim().length < 5) return 'Address too short (min 5 chars)';
        return '';
      default:
        return '';
    }
  };

  const handleFieldChange = (name, value) => {
    const processedValue = name === 'rollNo' ? (value === '' ? '' : Number(value)) : value;
    const newData = { ...formData, [name]: processedValue };
    setFormData(newData);
    
    if (formError) setFormError(null);

    if (touched[name]) {
        setErrors(prev => ({ ...prev, [name]: validateField(name, processedValue, newData) }));
    }
    if (name === 'dateOfBirth' && touched.admissionDate) {
         setErrors(prev => ({ ...prev, admissionDate: validateField('admissionDate', newData.admissionDate, newData) }));
    }
  };

  const handleBlur = (name) => {
      setTouched(prev => ({ ...prev, [name]: true }));
      setErrors(prev => ({ ...prev, [name]: validateField(name, formData[name], formData) }));
  };

  const handleSave = (e) => {
    e.preventDefault();
    const newErrors = {};
    let isValid = true;
    const fieldsToValidate = ['id', 'rollNo', 'fullName', 'contactNumber', 'className', 'section', 'dateOfBirth', 'admissionDate', 'address', 'gender'];
    
    fieldsToValidate.forEach(field => {
        const error = validateField(field, formData[field], formData);
        if (error) {
            newErrors[field] = error;
            isValid = false;
        }
    });

    setErrors(newErrors);
    setTouched(fieldsToValidate.reduce((acc, field) => ({...acc, [field]: true}), {}));

    if (!isValid) {
        setFormError("Please fix the errors in the form before saving.");
        return; 
    }

    try {
        db.saveStudent(formData);
        loadStudents();
        if (saveAction === 'SAVE_AND_NEW' && !isEdit) {
            const creds = generateNewCredentials();
            setFormData({...initialFormState, ...creds});
            resetFormState();
        } else {
            setViewMode('LIST');
        }
    } catch (err) {
        console.error(err);
        setFormError("Failed to save student data.");
    }
  };

  const handleGenerateAIReport = async () => {
      if(!process.env.API_KEY) {
          alert("API Key not configured in environment.");
          return;
      }
      setAiLoading(true);
      const exams = db.getExams().filter(e => e.studentId === formData.id);
      const attendance = db.getAttendance().filter(a => a.studentId === formData.id);
      
      const report = await generateStudentReport(formData, exams, attendance);
      setAiReport(report);
      setAiLoading(false);
  };

  const filteredStudents = students.filter(s => {
      const matchesSearch = 
        s.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || 
        s.rollNo.toString().includes(searchTerm) || 
        (s.id && s.id.toLowerCase().includes(searchTerm.toLowerCase()));
      const matchesClass = filterClass ? String(s.className) === String(filterClass) : true;
      const matchesSection = filterSection ? s.section === filterSection : true;
      return matchesSearch && matchesClass && matchesSection;
  });

  const clearFilters = () => {
      setFilterClass('');
      setFilterSection('');
      setSearchTerm('');
  };
  const hasActiveFilters = filterClass !== '' || filterSection !== '' || searchTerm !== '';

  if (viewMode === 'LIST') {
    return (
      <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-lg border border-white/10 overflow-hidden h-full flex flex-col">
        <div className="p-4 md:p-6 border-b border-white/10 flex flex-col gap-4">
          <div className="flex justify-between items-center">
            <div>
                <h2 className="text-xl font-bold text-white">Student Directory</h2>
                <p className="text-sm text-zinc-400">Manage records for {students.length} students</p>
            </div>
             <div className="flex gap-2">
                 <button 
                    onClick={handleExportCSV}
                    className="flex items-center justify-center p-2 md:px-4 md:py-2 bg-white/5 text-zinc-200 rounded-lg hover:bg-white/10 transition-colors text-sm font-medium border border-white/10"
                    title="Export to CSV"
                >
                    <Download size={18} />
                 </button>
                 <button 
                    onClick={handleAddNew}
                    className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium shadow-md shadow-indigo-900/50"
                >
                    <Plus size={18} /> <span className="hidden sm:inline">Add Student</span>
                 </button>
             </div>
          </div>
          
          <div className="flex flex-col lg:flex-row items-start lg:items-center gap-3 bg-white/5 p-3 rounded-xl border border-white/5">
             <div className="relative flex-1 w-full lg:w-auto">
                 <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" size={16} />
                 <input 
                    type="text" 
                    placeholder="Search Name, Roll No, ID..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-9 pr-3 py-2 bg-black/20 border border-white/10 rounded-lg text-sm text-zinc-200 placeholder-zinc-500 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"
                />
             </div>

             <div className="flex items-center gap-2 w-full lg:w-auto">
                 <div className="flex items-center gap-2 bg-black/20 p-1 rounded-lg border border-white/10 flex-1 lg:flex-none">
                    <div className="flex items-center px-2 border-r border-white/10">
                        <Filter size={14} className="text-zinc-400 mr-2"/>
                        <span className="text-xs font-bold text-zinc-500 uppercase tracking-wider">Filter</span>
                    </div>
                    <select 
                        value={filterClass} 
                        onChange={e => setFilterClass(e.target.value)}
                        className="bg-transparent outline-none text-sm p-1 text-zinc-300 w-24 cursor-pointer hover:text-white transition [&>option]:bg-zinc-900"
                    >
                        <option value="">All Classes</option>
                        {[...Array(12)].map((_, i) => <option key={i} value={i+1}>Class {i+1}</option>)}
                    </select>
                    <div className="w-px h-4 bg-white/10"></div>
                    <select 
                        value={filterSection} 
                        onChange={e => setFilterSection(e.target.value)}
                        className="bg-transparent outline-none text-sm p-1 text-zinc-300 w-24 cursor-pointer hover:text-white transition [&>option]:bg-zinc-900"
                    >
                        <option value="">All Sections</option>
                        {['A','B','C','D'].map(s => <option key={s} value={s}>Sec {s}</option>)}
                    </select>
                 </div>

                {hasActiveFilters && (
                    <button 
                        onClick={clearFilters}
                        className="p-2 text-zinc-400 hover:text-white hover:bg-red-500/20 rounded-lg transition-colors border border-transparent hover:border-red-500/30"
                        title="Clear Filters"
                    >
                        <RotateCcw size={18} />
                    </button>
                )}
             </div>
          </div>
        </div>

        <div className="overflow-x-auto flex-1 custom-scrollbar">
          <table className="w-full text-left text-sm text-zinc-300 min-w-[800px]">
            <thead className="bg-white/5 text-zinc-200 font-semibold uppercase tracking-wider sticky top-0 z-10 backdrop-blur-md">
              <tr>
                <th className="px-6 py-4 border-b border-white/10">ID</th>
                <th className="px-6 py-4 border-b border-white/10">Roll No</th>
                <th className="px-6 py-4 border-b border-white/10">Name</th>
                <th className="px-6 py-4 border-b border-white/10">Class</th>
                <th className="px-6 py-4 border-b border-white/10">Contact</th>
                <th className="px-6 py-4 border-b border-white/10 text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-white/5">
              {filteredStudents.length > 0 ? (
                  filteredStudents.map((student) => (
                    <tr key={student.id} className="hover:bg-white/5 transition-colors">
                      <td className="px-6 py-4 font-mono text-xs text-zinc-500">{student.id}</td>
                      <td className="px-6 py-4 font-medium text-indigo-300">#{student.rollNo}</td>
                      <td className="px-6 py-4 font-medium text-white">{student.fullName}</td>
                      <td className="px-6 py-4">
                          <span className="px-2 py-1 bg-white/10 rounded border border-white/10 text-xs font-medium">
                              {student.className} - {student.section}
                          </span>
                      </td>
                      <td className="px-6 py-4">{student.contactNumber}</td>
                      <td className="px-6 py-4 text-right flex justify-end gap-2">
                        <button onClick={() => handleEdit(student)} className="p-2 text-blue-300 hover:bg-blue-900/30 rounded-lg transition" title="Edit">
                            <Edit size={18} />
                        </button>
                        <button onClick={() => handleDelete(student.id)} className="p-2 text-red-300 hover:bg-red-900/30 rounded-lg transition" title="Delete">
                            <Trash2 size={18} />
                        </button>
                      </td>
                    </tr>
                  ))
              ) : (
                  <tr>
                      <td colSpan={6} className="px-6 py-12 text-center text-zinc-500">
                          <div className="flex flex-col items-center gap-2">
                              <Filter size={32} className="opacity-20"/>
                              <p>No students found matching criteria.</p>
                              {hasActiveFilters && (
                                  <button onClick={clearFilters} className="text-indigo-400 hover:underline text-xs">Clear Filters</button>
                              )}
                          </div>
                      </td>
                  </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto pb-10 h-full overflow-y-auto p-1 custom-scrollbar">
      <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-lg border border-white/10 overflow-hidden flex flex-col">
        <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5 sticky top-0 z-20 backdrop-blur-xl">
          <h2 className="text-lg md:text-xl font-bold text-white">
            {isEdit ? 'Update Student Details' : 'New Student Registration'}
          </h2>
          <button onClick={() => setViewMode('LIST')} className="text-zinc-400 hover:text-white transition">
            <X size={24} />
          </button>
        </div>
        
        <div className="p-4 md:p-8">
            <form onSubmit={handleSave} className="grid grid-cols-1 md:grid-cols-2 gap-6" noValidate>
                <FormField 
                    label="Student ID / Admission No" 
                    name="id" 
                    placeholder="Auto-generated" 
                    value={formData.id}
                    error={errors.id}
                    touched={touched.id}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                    disabled={true} 
                />

                <FormField 
                    label="Roll Number" 
                    name="rollNo" 
                    type="number"
                    placeholder="e.g. 101"
                    value={formData.rollNo}
                    error={errors.rollNo}
                    touched={touched.rollNo}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                <FormField 
                    label="Full Name" 
                    name="fullName" 
                    placeholder="e.g. John Doe" 
                    value={formData.fullName}
                    error={errors.fullName}
                    touched={touched.fullName}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                <CustomDatePicker 
                    label="Admission Date"
                    value={formData.admissionDate}
                    onChange={(val) => handleFieldChange('admissionDate', val)}
                    error={errors.admissionDate}
                    touched={touched.admissionDate}
                />

                <FormField 
                    label="Class" 
                    name="className" 
                    options={[...Array(12)].map((_, i) => ({value: i+1, label: i+1}))} 
                    value={formData.className}
                    error={errors.className}
                    touched={touched.className}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                <FormField 
                    label="Section" 
                    name="section" 
                    options={['A','B','C','D'].map(s => ({value: s, label: s}))} 
                    value={formData.section}
                    error={errors.section}
                    touched={touched.section}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                <FormField 
                    label="Gender" 
                    name="gender" 
                    options={[{value: 'Male', label: 'Male'}, {value: 'Female', label: 'Female'}, {value: 'Other', label: 'Other'}]} 
                    value={formData.gender}
                    error={errors.gender}
                    touched={touched.gender}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                <CustomDatePicker 
                    label="Date of Birth"
                    value={formData.dateOfBirth}
                    onChange={(val) => handleFieldChange('dateOfBirth', val)}
                    error={errors.dateOfBirth}
                    touched={touched.dateOfBirth}
                />

                <FormField 
                    label="Contact Number" 
                    name="contactNumber" 
                    type="tel"
                    placeholder="10-digit mobile number" 
                    value={formData.contactNumber}
                    error={errors.contactNumber}
                    touched={touched.contactNumber}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                <FormField 
                    label="Address" 
                    name="address" 
                    placeholder="Full residential address (min 5 chars)" 
                    value={formData.address}
                    error={errors.address}
                    touched={touched.address}
                    onChange={handleFieldChange}
                    onBlur={handleBlur}
                />

                {formError && (
                    <div className="col-span-1 md:col-span-2 bg-red-500/10 border border-red-500/20 p-3 rounded-lg text-red-200 text-sm flex items-center gap-2 animate-in slide-in-from-top-2">
                        <AlertCircle size={18} /> {formError}
                    </div>
                )}

                <div className="col-span-1 md:col-span-2 flex flex-col md:flex-row gap-4 mt-4 border-t border-white/10 pt-6">
                    <button 
                        type="submit" 
                        onClick={() => setSaveAction('SAVE')}
                        className="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition shadow-lg shadow-indigo-900/50 flex justify-center items-center gap-2"
                    >
                        <Save size={20} /> {isEdit ? 'Update Student' : 'Save Student'}
                    </button>
                    
                    {!isEdit && (
                        <button 
                            type="submit"
                            onClick={() => setSaveAction('SAVE_AND_NEW')}
                            className="flex-1 bg-white/5 text-indigo-300 border border-white/10 py-3 rounded-lg font-medium hover:bg-white/10 transition flex justify-center items-center gap-2"
                        >
                            <CopyPlus size={20} /> Save & Add Another
                        </button>
                    )}

                    <button 
                        type="button" 
                        onClick={() => {
                            const creds = generateNewCredentials();
                            setFormData({...initialFormState, ...creds});
                            resetFormState();
                        }} 
                        className="px-6 py-3 border border-white/10 text-zinc-400 rounded-lg font-medium hover:bg-white/5 transition whitespace-nowrap"
                    >
                        Clear Form
                    </button>
                </div>
            </form>

            {isEdit && (
                <div className="mt-8 rounded-xl bg-gradient-to-br from-indigo-900/20 via-purple-900/20 to-transparent border border-indigo-500/20 overflow-hidden">
                    <div className="p-6 backdrop-blur-sm">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                             <div>
                                 <h3 className="text-lg font-bold text-white flex items-center gap-2">
                                     <Sparkles className="text-purple-400" size={20} /> 
                                     AI Performance Insight
                                 </h3>
                                 <p className="text-xs text-zinc-400 mt-1">
                                    Generates a professional report card summary based on exams & attendance.
                                 </p>
                             </div>
                             <button 
                                onClick={handleGenerateAIReport}
                                disabled={aiLoading}
                                className="group relative inline-flex items-center justify-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg font-medium overflow-hidden transition-all hover:bg-purple-700 shadow-lg shadow-purple-900/40 disabled:opacity-70 disabled:cursor-not-allowed w-full sm:w-auto"
                             >
                                 {aiLoading ? (
                                     <span className="flex items-center gap-2">
                                        <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                        Analyzing Data...
                                     </span>
                                 ) : (
                                     <>
                                        <Wand2 size={16} className="group-hover:rotate-12 transition-transform" />
                                        <span>Generate Report</span>
                                     </>
                                 )}
                             </button>
                        </div>
                        
                        {aiReport && (
                            <div className="bg-black/40 border border-white/10 p-5 rounded-xl text-zinc-200 text-sm leading-relaxed italic shadow-inner relative animate-in fade-in slide-in-from-bottom-2 duration-500">
                                <div className="absolute -top-2 -left-2 text-4xl text-white/10 font-serif">"</div>
                                <p className="relative z-10">{aiReport}</p>
                                <div className="absolute -bottom-4 -right-2 text-4xl text-white/10 font-serif">"</div>
                            </div>
                        )}
                        
                        {!aiReport && !aiLoading && (
                            <div className="text-center py-6 text-zinc-500 text-xs border-2 border-dashed border-white/5 rounded-xl">
                                Click generate to analyze student performance data.
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
      </div>
    </div>
  );
};

// 4. FEES MANAGER
const FeesManager = () => {
  const [students, setStudents] = useState([]);
  const [fees, setFees] = useState([]);
  const [academicYear] = useState('2023-2024');
  const [expandedStudent, setExpandedStudent] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('ALL');
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [selectedPayment, setSelectedPayment] = useState(null);
  const [paymentForm, setPaymentForm] = useState({
      amount: 0,
      mode: 'CASH',
      date: new Date().toISOString().split('T')[0],
      transactionId: ''
  });
  const [showReceipt, setShowReceipt] = useState(null);
  const [receiptStudent, setReceiptStudent] = useState(null);

  const SEMESTER_FEE = 11000;

  useEffect(() => {
    loadData();
  }, []);

  const loadData = () => {
    setStudents(db.getStudents());
    setFees(db.getFees());
  };

  const getFeeRecord = (studentId) => {
    const existing = fees.find(f => f.studentId === studentId && f.academicYear === academicYear);
    if (existing) return existing;
    return {
        id: `${studentId}-${academicYear}`,
        studentId,
        academicYear,
        semester1Paid: false,
        semester2Paid: false,
        transactions: []
    };
  };

  const getSemesterStats = (record, semester) => {
      const txns = record.transactions || [];
      const paid = txns.filter(t => t.semester === semester).reduce((sum, t) => sum + t.amount, 0);
      const due = SEMESTER_FEE - paid;
      const status = paid >= SEMESTER_FEE ? 'PAID' : paid > 0 ? 'PARTIAL' : 'PENDING';
      return { paid, due, status };
  };

  const totalStudents = students.length;
  const totalExpectedRevenue = totalStudents * SEMESTER_FEE * 2;
  const totalCollected = fees.reduce((acc, f) => {
      const txns = f.transactions || [];
      return acc + txns.reduce((sum, t) => sum + t.amount, 0);
  }, 0);
  const pendingRevenue = totalExpectedRevenue - totalCollected;
  const defaultersCount = students.filter(s => {
      const r = getFeeRecord(s.id);
      const s1 = getSemesterStats(r, 1);
      const s2 = getSemesterStats(r, 2);
      return s1.status !== 'PAID' || s2.status !== 'PAID';
  }).length;

  const initiatePayment = (student, semester) => {
      const record = getFeeRecord(student.id);
      const stats = getSemesterStats(record, semester);

      if (stats.status === 'PAID') {
          alert(`Semester ${semester} fees are already fully paid.`);
          return;
      }

      setSelectedPayment({
          studentId: student.id,
          studentName: student.fullName,
          semester,
          currentDue: stats.due
      });
      setPaymentForm({
          amount: stats.due,
          mode: 'CASH',
          date: new Date().toISOString().split('T')[0],
          transactionId: `TXN-${Date.now()}`
      });
      setShowPaymentModal(true);
  };

  const processPayment = (e) => {
      e.preventDefault();
      if (!selectedPayment) return;

      if (paymentForm.amount <= 0) {
          alert("Please enter a valid amount.");
          return;
      }
      if (paymentForm.amount > selectedPayment.currentDue) {
          alert(`Amount exceeds the due balance of ${selectedPayment.currentDue}`);
          return;
      }

      const record = getFeeRecord(selectedPayment.studentId);
      const newTransaction = {
          id: paymentForm.transactionId || `TXN-${Date.now()}`,
          date: paymentForm.date,
          amount: paymentForm.amount,
          type: paymentForm.mode,
          semester: selectedPayment.semester
      };

      const updatedRecord = { ...record };
      if (!updatedRecord.transactions) updatedRecord.transactions = [];
      updatedRecord.transactions.push(newTransaction);

      const s1Stats = getSemesterStats(updatedRecord, 1);
      const s2Stats = getSemesterStats(updatedRecord, 2);
      
      updatedRecord.semester1Paid = s1Stats.status === 'PAID';
      updatedRecord.semester2Paid = s2Stats.status === 'PAID';
      updatedRecord.lastPaymentDate = paymentForm.date;

      db.saveFeeRecord(updatedRecord);
      loadData();
      setShowPaymentModal(false);
      
      const student = students.find(s => s.id === selectedPayment.studentId);
      if(student) {
        handleShowReceipt(newTransaction, student);
      }
  };

  const handleShowReceipt = (txn, student) => {
      setReceiptStudent(student);
      setShowReceipt(txn);
  };

  const toggleHistory = (studentId) => {
      setExpandedStudent(expandedStudent === studentId ? null : studentId);
  };

  const filteredStudents = students.filter(s => {
      const record = getFeeRecord(s.id);
      const s1 = getSemesterStats(record, 1);
      const s2 = getSemesterStats(record, 2);
      
      const matchesSearch = s.fullName.toLowerCase().includes(searchTerm.toLowerCase()) || 
                            s.rollNo.toString().includes(searchTerm);
      
      if (statusFilter === 'PAID') {
          return matchesSearch && (s1.status === 'PAID' && s2.status === 'PAID');
      }
      if (statusFilter === 'PENDING') {
          return matchesSearch && (s1.status === 'PENDING' || s2.status === 'PENDING');
      }
      if (statusFilter === 'PARTIAL') {
          return matchesSearch && (s1.status === 'PARTIAL' || s2.status === 'PARTIAL');
      }
      return matchesSearch;
  });

  return (
    <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col relative">
      <div className="p-6 border-b border-white/10 space-y-6">
        <div className="flex justify-between items-start">
            <div>
                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                    <Banknote className="text-green-400" /> Fees Management
                </h2>
                <p className="text-zinc-400 text-sm mt-1">Academic Year: {academicYear}</p>
            </div>
            <div className="flex gap-2">
                <div className="text-right hidden md:block">
                    <div className="text-xs text-zinc-400">Standard Fee</div>
                    <div className="text-lg font-bold text-white">{SEMESTER_FEE.toLocaleString()} <span className="text-xs font-normal text-zinc-500">/ sem</span></div>
                </div>
            </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="bg-green-500/10 border border-green-500/20 p-4 rounded-xl">
                <div className="text-zinc-400 text-xs uppercase font-bold tracking-wider mb-1">Total Collected</div>
                <div className="text-2xl font-bold text-green-400">{totalCollected.toLocaleString()}</div>
                <div className="text-xs text-green-500/60 mt-1">Revenue realized</div>
            </div>
            <div className="bg-orange-500/10 border border-orange-500/20 p-4 rounded-xl">
                <div className="text-zinc-400 text-xs uppercase font-bold tracking-wider mb-1">Pending Fees</div>
                <div className="text-2xl font-bold text-orange-400">{pendingRevenue.toLocaleString()}</div>
                <div className="text-xs text-orange-500/60 mt-1">Outstanding amount</div>
            </div>
            <div className="bg-red-500/10 border border-red-500/20 p-4 rounded-xl">
                <div className="text-zinc-400 text-xs uppercase font-bold tracking-wider mb-1">Defaulters</div>
                <div className="text-2xl font-bold text-red-400">{defaultersCount}</div>
                <div className="text-xs text-red-500/60 mt-1">Students with dues</div>
            </div>
        </div>

        <div className="flex flex-col md:flex-row gap-4">
            <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500" size={16} />
                <input 
                    type="text" 
                    placeholder="Search by Name or Roll No..." 
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="w-full pl-9 pr-4 py-2.5 bg-black/20 border border-white/10 rounded-lg text-sm text-zinc-200 outline-none focus:ring-2 focus:ring-indigo-500"
                />
            </div>
            <div className="flex items-center gap-2 bg-black/20 p-1 rounded-lg border border-white/10 overflow-x-auto">
                {['ALL', 'PAID', 'PARTIAL', 'PENDING'].map((filter) => (
                    <button 
                        key={filter}
                        onClick={() => setStatusFilter(filter)}
                        className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all whitespace-nowrap ${
                            statusFilter === filter 
                            ? 'bg-white/10 text-white shadow-sm' 
                            : 'text-zinc-400 hover:text-zinc-200'
                        }`}
                    >
                        {filter.charAt(0) + filter.slice(1).toLowerCase()}
                    </button>
                ))}
            </div>
        </div>
      </div>

      <div className="overflow-x-auto flex-1 custom-scrollbar">
        <table className="w-full text-left text-sm text-zinc-300 min-w-[900px]">
          <thead className="bg-white/5 text-zinc-200 font-semibold uppercase tracking-wider sticky top-0 z-10 backdrop-blur-md">
            <tr>
              <th className="px-6 py-4 border-b border-white/10">Student Info</th>
              <th className="px-6 py-4 border-b border-white/10 text-center">Sem 1 Status</th>
              <th className="px-6 py-4 border-b border-white/10 text-center">Sem 2 Status</th>
              <th className="px-6 py-4 border-b border-white/10 text-center">Total Paid</th>
              <th className="px-6 py-4 border-b border-white/10 text-center">History</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/10">
            {filteredStudents.length > 0 ? filteredStudents.map((student) => {
              const record = getFeeRecord(student.id);
              const s1 = getSemesterStats(record, 1);
              const s2 = getSemesterStats(record, 2);
              const totalPaid = s1.paid + s2.paid;
              const isExpanded = expandedStudent === student.id;

              const renderStatus = (stats, semester) => (
                  <div className="flex flex-col items-center gap-1">
                      <button 
                          onClick={() => initiatePayment(student, semester)}
                          disabled={stats.status === 'PAID'}
                          className={`group relative px-4 py-1.5 rounded-full text-xs font-bold flex items-center justify-center gap-2 transition-all w-32
                              ${stats.status === 'PAID'
                                  ? 'bg-green-500/20 text-green-300 border border-green-500/20 cursor-default' 
                                  : stats.status === 'PARTIAL'
                                  ? 'bg-yellow-500/20 text-yellow-300 border border-yellow-500/20 hover:bg-indigo-600 hover:text-white hover:border-indigo-600'
                                  : 'bg-white/5 text-zinc-400 border border-white/10 hover:bg-indigo-600 hover:text-white hover:border-indigo-600 hover:shadow-lg hover:shadow-indigo-900/50'
                              }`}
                      >
                          {stats.status === 'PAID' ? (
                              <><CheckCircle size={14} /> <span>PAID</span></>
                          ) : stats.status === 'PARTIAL' ? (
                              <><AlertCircle size={14} /> <span>PARTIAL</span></>
                          ) : (
                              <><Wallet size={14} /> <span>PAY NOW</span></>
                          )}
                      </button>
                      {stats.status !== 'PAID' && (
                          <div className="text-[10px] text-zinc-500 font-mono">
                              Due: <span className="text-red-400">{stats.due.toLocaleString()}</span>
                          </div>
                      )}
                  </div>
              );

              return (
                <React.Fragment key={student.id}>
                    <tr className="hover:bg-white/5 transition-colors">
                        <td className="px-6 py-4">
                            <div className="font-medium text-white text-base">{student.fullName}</div>
                            <div className="text-xs text-zinc-400 mt-0.5">Roll: <span className="text-zinc-300">#{student.rollNo}</span> | Class: {student.className}-{student.section}</div>
                        </td>
                        <td className="px-6 py-4 text-center">
                            {renderStatus(s1, 1)}
                        </td>
                        <td className="px-6 py-4 text-center">
                            {renderStatus(s2, 2)}
                        </td>
                        <td className="px-6 py-4 text-center font-mono font-medium text-white bg-white/5">
                            {totalPaid.toLocaleString()}
                        </td>
                        <td className="px-6 py-4 text-center">
                            <button onClick={() => toggleHistory(student.id)} className={`p-2 rounded-lg transition ${isExpanded ? 'bg-indigo-600 text-white shadow-lg' : 'text-zinc-400 hover:bg-white/10 hover:text-white'}`}>
                                {isExpanded ? <ChevronUp size={18}/> : <History size={18}/>}
                            </button>
                        </td>
                    </tr>
                    {isExpanded && (
                        <tr className="bg-black/30 shadow-inner">
                            <td colSpan={5} className="px-6 py-6 border-b border-white/10">
                                <div className="bg-zinc-900/50 rounded-xl border border-white/10 p-4">
                                    <h4 className="text-xs font-bold text-zinc-400 uppercase mb-4 tracking-wider flex items-center gap-2">
                                        <Receipt size={14} /> Transaction History
                                    </h4>
                                    {record.transactions && record.transactions.length > 0 ? (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {record.transactions.map((t, idx) => (
                                                <div key={idx} className="relative bg-black/40 p-4 rounded-lg border border-white/5 hover:border-indigo-500/30 transition-colors group">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center gap-2">
                                                            <span className={`p-1.5 rounded bg-white/5 ${t.type === 'UPI' ? 'text-blue-400' : t.type === 'CASH' ? 'text-green-400' : 'text-purple-400'}`}>
                                                                <CreditCard size={14} />
                                                            </span>
                                                            <span className="font-medium text-zinc-200 text-sm">{t.type}</span>
                                                        </div>
                                                        <div className="text-xs text-zinc-500 font-mono">{t.date}</div>
                                                    </div>
                                                    <div className="flex justify-between items-end">
                                                        <div>
                                                            <div className="text-xs text-zinc-500 mb-0.5">Semester {t.semester}</div>
                                                            <div className="font-mono text-lg font-bold text-white">{t.amount.toLocaleString()}</div>
                                                        </div>
                                                        <button 
                                                            onClick={() => handleShowReceipt(t, student)}
                                                            className="opacity-0 group-hover:opacity-100 p-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-all shadow-lg"
                                                            title="Print Receipt"
                                                        >
                                                            <Printer size={14} />
                                                        </button>
                                                    </div>
                                                    <div className="absolute top-2 right-2 text-[10px] text-zinc-600 font-mono">{t.id}</div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="text-sm text-zinc-500 italic text-center py-4">No transactions recorded yet.</div>
                                    )}
                                </div>
                            </td>
                        </tr>
                    )}
                </React.Fragment>
              );
            }) : (
                <tr>
                    <td colSpan={5} className="py-12 text-center text-zinc-500">
                        No students found matching criteria.
                    </td>
                </tr>
            )}
          </tbody>
        </table>
      </div>

      {showPaymentModal && selectedPayment && (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
              <div className="bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden animate-in zoom-in-95 duration-200">
                  <div className="p-6 border-b border-white/10 bg-white/5 flex justify-between items-center">
                      <div>
                          <h3 className="text-xl font-bold text-white">Collect Fees</h3>
                          <p className="text-sm text-zinc-400">Semester {selectedPayment.semester} Payment</p>
                      </div>
                      <button onClick={() => setShowPaymentModal(false)} className="text-zinc-400 hover:text-white"><XCircle size={24} /></button>
                  </div>
                  <form onSubmit={processPayment} className="p-6 space-y-5">
                      <div>
                          <label className="block text-xs font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Student</label>
                          <div className="text-lg font-medium text-white">{selectedPayment.studentName}</div>
                          <div className="text-sm text-zinc-400 font-mono mt-0.5">ID: {selectedPayment.studentId}</div>
                      </div>

                      <div className="bg-white/5 p-3 rounded-lg border border-white/10">
                          <div className="flex justify-between text-sm mb-1">
                                <span className="text-zinc-400">Total Fee</span>
                                <span className="text-zinc-200">{SEMESTER_FEE.toLocaleString()}</span>
                          </div>
                          <div className="flex justify-between text-sm">
                                <span className="text-zinc-400">Pending Due</span>
                                <span className="text-red-400 font-bold">{selectedPayment.currentDue.toLocaleString()}</span>
                          </div>
                      </div>
                      
                      <div>
                          <label className="block text-xs font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Paying Amount ()</label>
                          <input 
                              type="number" 
                              max={selectedPayment.currentDue}
                              min={1}
                              value={paymentForm.amount}
                              onChange={e => setPaymentForm({...paymentForm, amount: Number(e.target.value)})}
                              className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-3 text-xl font-mono text-white focus:ring-2 focus:ring-green-500 outline-none"
                          />
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                          <div>
                              <label className="block text-xs font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Payment Mode</label>
                              <select 
                                  value={paymentForm.mode}
                                  onChange={e => setPaymentForm({...paymentForm, mode: e.target.value})}
                                  className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2.5 text-white focus:ring-2 focus:ring-indigo-500 outline-none [&>option]:bg-zinc-900"
                              >
                                  <option value="CASH">Cash</option>
                                  <option value="UPI">UPI / GPay</option>
                                  <option value="CHEQUE">Cheque</option>
                                  <option value="ONLINE">Net Banking</option>
                              </select>
                          </div>
                          <div>
                              <label className="block text-xs font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Date</label>
                              <input 
                                  type="date"
                                  value={paymentForm.date}
                                  onChange={e => setPaymentForm({...paymentForm, date: e.target.value})}
                                  className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2.5 text-white focus:ring-2 focus:ring-indigo-500 outline-none [color-scheme:dark]"
                              />
                          </div>
                      </div>

                      <div>
                          <label className="block text-xs font-medium text-zinc-500 uppercase tracking-wider mb-1.5">Transaction ID (Optional)</label>
                          <input 
                              type="text" 
                              placeholder="Auto-generated if empty"
                              value={paymentForm.transactionId}
                              onChange={e => setPaymentForm({...paymentForm, transactionId: e.target.value})}
                              className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:ring-2 focus:ring-indigo-500 outline-none"
                          />
                      </div>

                      <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-green-900/40 transition flex items-center justify-center gap-2 mt-4">
                          <CheckCircle size={20} /> Confirm Payment
                      </button>
                  </form>
              </div>
          </div>
      )}

      {showReceipt && receiptStudent && (
          <div className="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center z-[60] p-4">
              <div className="bg-white text-zinc-900 rounded-lg shadow-2xl w-full max-w-sm overflow-hidden relative animate-in zoom-in-95 duration-200">
                  <div className="p-8 border-b-2 border-zinc-100 border-dashed flex flex-col items-center text-center">
                      <div className="w-12 h-12 bg-zinc-900 text-white rounded-full flex items-center justify-center mb-3">
                          <Banknote size={24} />
                      </div>
                      <h2 className="text-xl font-bold tracking-tight">Udaan Vidhyalay</h2>
                      <p className="text-xs text-zinc-500 uppercase tracking-widest mt-1">Payment Receipt</p>
                  </div>
                  
                  <div className="p-8 space-y-4">
                      <div className="flex justify-between items-center">
                          <span className="text-sm text-zinc-500">Date</span>
                          <span className="font-medium">{showReceipt.date}</span>
                      </div>
                      <div className="flex justify-between items-center">
                          <span className="text-sm text-zinc-500">Receipt No</span>
                          <span className="font-mono text-xs bg-zinc-100 px-2 py-1 rounded">{showReceipt.id}</span>
                      </div>
                      <div className="border-t border-dashed border-zinc-200 my-2"></div>
                      <div>
                          <span className="text-xs text-zinc-400 block mb-1">Student Details</span>
                          <div className="font-bold">{receiptStudent.fullName}</div>
                          <div className="text-sm text-zinc-600">Class {receiptStudent.className} - {receiptStudent.section}</div>
                      </div>
                      <div>
                          <span className="text-xs text-zinc-400 block mb-1">Description</span>
                          <div className="flex justify-between">
                              <span className="text-sm font-medium">Semester {showReceipt.semester} Fees</span>
                              <span className="font-bold">{showReceipt.amount.toLocaleString()}</span>
                          </div>
                      </div>
                      <div className="bg-zinc-50 p-3 rounded-lg flex justify-between items-center border border-zinc-100 mt-4">
                          <span className="text-sm text-zinc-500">Paid via</span>
                          <span className="font-bold text-zinc-800">{showReceipt.type}</span>
                      </div>
                  </div>

                  <div className="bg-zinc-900 p-4 text-white text-center">
                       <div className="flex gap-2 justify-center">
                            <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-white text-zinc-900 rounded-md text-sm font-bold hover:bg-zinc-200 transition">
                                <Printer size={16} /> Print
                            </button>
                            <button onClick={() => setShowReceipt(null)} className="px-4 py-2 border border-white/20 rounded-md text-sm font-medium hover:bg-white/10 transition">
                                Close
                            </button>
                       </div>
                  </div>
                  <div className="absolute top-[148px] -left-3 w-6 h-6 bg-zinc-900 rounded-full"></div>
                  <div className="absolute top-[148px] -right-3 w-6 h-6 bg-zinc-900 rounded-full"></div>
              </div>
          </div>
      )}
    </div>
  );
};

// 5. ATTENDANCE MANAGER
const AttendanceManager = () => {
  const [students, setStudents] = useState([]);
  const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
  const [attendanceMap, setAttendanceMap] = useState({});
  const [aiAnalysis, setAiAnalysis] = useState(null);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  useEffect(() => {
    setStudents(db.getStudents());
    loadAttendanceForDate(selectedDate);
  }, [selectedDate]);

  const loadAttendanceForDate = (date) => {
    const records = db.getAttendance().filter(r => r.date === date);
    const map = {};
    records.forEach(r => {
        map[r.studentId] = r.status;
    });
    setAttendanceMap(map);
  };

  const updateStatus = (studentId, status) => {
    const newMap = { ...attendanceMap, [studentId]: status };
    setAttendanceMap(newMap);

    const existing = db.getAttendance().find(r => r.studentId === studentId && r.date === selectedDate);
    const record = {
        id: existing ? existing.id : `${studentId}-${selectedDate}`,
        studentId,
        date: selectedDate,
        status
    };
    db.saveAttendance(record);
  };

  const markAll = (status) => {
      students.forEach(s => updateStatus(s.id, status));
  };

  const handleAnalyze = async () => {
      setIsAnalyzing(true);
      setAiAnalysis(null);
      const allRecords = db.getAttendance();
      const result = await generateAttendanceAnalysis(allRecords, students.length);
      setAiAnalysis(result);
      setIsAnalyzing(false);
  };

  return (
    <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col">
      <div className="p-4 md:p-6 border-b border-white/10 flex flex-col md:flex-row justify-between md:items-center gap-4">
        <div>
             <h2 className="text-xl font-bold text-white flex items-center gap-2">
                <Calendar className="text-indigo-400" /> Daily Attendance
            </h2>
        </div>
        <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
            <button 
                onClick={handleAnalyze}
                disabled={isAnalyzing}
                className="flex justify-center items-center gap-2 bg-purple-600/90 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-purple-700 transition shadow-md shadow-purple-900/50 disabled:opacity-70 backdrop-blur-sm"
            >
                <BrainCircuit size={18} />
                {isAnalyzing ? 'Analyzing...' : 'AI Insights'}
            </button>
            <div className="hidden sm:block w-px h-8 bg-white/10 mx-2"></div>
            
            <div className="flex items-center gap-2 w-full sm:w-auto">
                <input 
                    type="date" 
                    value={selectedDate} 
                    onChange={e => setSelectedDate(e.target.value)}
                    className="flex-1 sm:flex-none border border-white/10 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-white/5 text-white [color-scheme:dark]"
                />
                <div className="flex gap-2">
                    <button onClick={() => markAll('Present')} className="px-3 py-2 sm:py-1 text-xs bg-green-500/20 text-green-300 rounded hover:bg-green-500/30 border border-green-500/20 whitespace-nowrap transition">All Present</button>
                    <button onClick={() => markAll('Absent')} className="px-3 py-2 sm:py-1 text-xs bg-red-500/20 text-red-300 rounded hover:bg-red-500/30 border border-red-500/20 whitespace-nowrap transition">All Absent</button>
                </div>
            </div>
        </div>
      </div>

      {aiAnalysis && (
          <div className="mx-4 md:mx-6 mt-4 md:mt-6 p-4 bg-purple-900/30 border border-purple-500/30 rounded-xl shadow-inner animate-in fade-in slide-in-from-top-4 duration-300 backdrop-blur-md">
              <div className="flex justify-between items-start mb-2">
                  <h3 className="font-bold text-purple-200 flex items-center gap-2">
                      <BrainCircuit size={18} /> Attendance Analysis Report
                  </h3>
                  <button onClick={() => setAiAnalysis(null)} className="text-purple-300 hover:text-purple-100">Close</button>
              </div>
              <div className="prose prose-sm text-zinc-200 max-w-none whitespace-pre-line leading-relaxed">
                  {aiAnalysis}
              </div>
          </div>
      )}

      <div className="overflow-auto flex-1 p-4 md:p-6 custom-scrollbar">
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            {students.map(student => {
                const status = attendanceMap[student.id] || 'Present';
                const isMarked = attendanceMap[student.id] !== undefined;

                return (
                    <div key={student.id} className={`p-4 rounded-lg border backdrop-blur-sm transition-all ${isMarked ? 'border-white/10 bg-white/5' : 'border-orange-500/30 bg-orange-500/10'}`}>
                        <div className="flex justify-between items-start mb-3">
                            <div>
                                <h3 className="font-semibold text-zinc-200 truncate max-w-[150px]">{student.fullName}</h3>
                                <p className="text-xs text-zinc-400">#{student.rollNo}  {student.className}-{student.section}</p>
                            </div>
                            {!isMarked && <span className="text-[10px] bg-orange-500/20 text-orange-300 px-1.5 py-0.5 rounded border border-orange-500/20">Unmarked</span>}
                        </div>
                        
                        <div className="flex gap-1 bg-black/20 p-1 rounded-md border border-white/5">
                            {['Present', 'Absent', 'Late', 'Excused'].map((opt) => (
                                <button
                                    key={opt}
                                    onClick={() => updateStatus(student.id, opt)}
                                    className={`flex-1 text-xs py-1.5 rounded font-medium transition-all ${
                                        status === opt 
                                        ? opt === 'Present' ? 'bg-green-600 text-white shadow-sm' 
                                          : opt === 'Absent' ? 'bg-red-600 text-white shadow-sm'
                                          : 'bg-yellow-600 text-white shadow-sm'
                                        : 'text-zinc-500 hover:bg-white/10 hover:text-zinc-300'
                                    }`}
                                >
                                    {opt[0]}
                                </button>
                            ))}
                        </div>
                    </div>
                )
            })}
        </div>
      </div>
    </div>
  );
};

// 6. EXAM MANAGER
const ExamManager = () => {
  const [students, setStudents] = useState([]);
  const [examType, setExamType] = useState('Mid-Term');
  const [subject, setSubject] = useState('Mathematics');
  const [results, setResults] = useState({});

  const subjects = ['Mathematics', 'Science', 'English', 'Social Studies', 'Hindi'];

  useEffect(() => {
    const s = db.getStudents();
    setStudents(s);
    loadResults(s, examType, subject);
  }, [examType, subject]);

  const loadResults = (studentList, type, sub) => {
    const allResults = db.getExams();
    const mapping = {};
    studentList.forEach(s => {
        const match = allResults.find(r => r.studentId === s.id && r.examType === type && r.subject === sub);
        if(match) mapping[s.id] = match.marksObtained;
    });
    setResults(mapping);
  };

  const handleMarkChange = (studentId, marks) => {
    const val = parseFloat(marks);
    if (marks === '') {
        const newResults = {...results};
        delete newResults[studentId];
        setResults(newResults);
        return;
    }
    if(isNaN(val) || val < 0 || val > 100) return; 
    setResults(prev => ({...prev, [studentId]: val}));
  };

  const saveAll = () => {
      students.forEach(s => {
          if (results[s.id] !== undefined) {
              const result = {
                  id: `${s.id}-${examType}-${subject}`,
                  studentId: s.id,
                  subject,
                  examType,
                  marksObtained: results[s.id],
                  totalMarks: 100
              };
              db.saveExamResult(result);
          }
      });
      alert("Marks saved successfully!");
  };

  return (
    <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col">
      <div className="p-4 md:p-6 border-b border-white/10 flex flex-col md:flex-row justify-between md:items-center gap-4">
        <h2 className="text-xl font-bold text-white flex items-center gap-2">
            <FileSpreadsheet className="text-indigo-400" /> Exam Results
        </h2>
        <div className="flex gap-3 w-full md:w-auto">
            <select value={examType} onChange={e => setExamType(e.target.value)} className="flex-1 md:flex-none border border-white/10 rounded-lg p-2 text-sm bg-white/5 text-white outline-none focus:ring-2 focus:ring-indigo-500 [&>option]:bg-zinc-900">
                <option value="Mid-Term">Mid-Term</option>
                <option value="Final">Final</option>
            </select>
            <select value={subject} onChange={e => setSubject(e.target.value)} className="flex-1 md:flex-none border border-white/10 rounded-lg p-2 text-sm bg-white/5 text-white outline-none focus:ring-2 focus:ring-indigo-500 [&>option]:bg-zinc-900">
                {subjects.map(s => <option key={s} value={s}>{s}</option>)}
            </select>
        </div>
      </div>

      <div className="overflow-x-auto flex-1 custom-scrollbar">
        <table className="w-full text-left text-sm text-zinc-300 min-w-[700px]">
          <thead className="bg-white/5 text-zinc-200 font-semibold uppercase tracking-wider sticky top-0 z-10 backdrop-blur-md">
            <tr>
                <th className="px-6 py-4 border-b border-white/10">Roll No</th>
                <th className="px-6 py-4 border-b border-white/10">Student Name</th>
                <th className="px-6 py-4 border-b border-white/10 text-center">Total Marks</th>
                <th className="px-6 py-4 border-b border-white/10 text-center">Obtained Marks</th>
                <th className="px-6 py-4 border-b border-white/10 text-center">Grade</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-white/10">
            {students.map(student => {
                const marks = results[student.id];
                const hasMarks = marks !== undefined;
                let grade = '-';
                
                if (hasMarks) {
                    if(marks >= 90) grade = 'A+';
                    else if(marks >= 80) grade = 'A';
                    else if(marks >= 70) grade = 'B';
                    else if(marks >= 60) grade = 'C';
                    else if(marks >= 40) grade = 'D';
                    else grade = 'F';
                }

                return (
                    <tr key={student.id} className="hover:bg-white/5 transition-colors">
                        <td className="px-6 py-4 text-zinc-400">#{student.rollNo}</td>
                        <td className="px-6 py-4 font-medium text-zinc-200">{student.fullName}</td>
                        <td className="px-6 py-4 text-center">100</td>
                        <td className="px-6 py-4 text-center">
                            <input 
                                type="number" 
                                value={hasMarks ? marks : ''} 
                                onChange={e => handleMarkChange(student.id, e.target.value)}
                                className="w-20 p-2 border border-white/10 rounded text-center focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 outline-none bg-white/5 text-white transition-all placeholder-zinc-600"
                                placeholder="0"
                            />
                        </td>
                        <td className={`px-6 py-4 text-center font-bold ${grade === 'F' ? 'text-red-400' : 'text-green-400'}`}>{grade}</td>
                    </tr>
                );
            })}
          </tbody>
        </table>
      </div>
      <div className="p-4 border-t border-white/10 bg-white/5 flex justify-end backdrop-blur-md">
        <button 
            onClick={saveAll}
            className="w-full md:w-auto flex items-center justify-center gap-2 bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-md shadow-indigo-900/50"
        >
            <Save size={20} /> Save Results
        </button>
      </div>
    </div>
  );
};

// 7. TEACHER MANAGER
const TeacherManager = () => {
    const [teachers, setTeachers] = useState([]);
    const [activeTab, setActiveTab] = useState('LIST');
    const [showForm, setShowForm] = useState(false);
    const [searchTerm, setSearchTerm] = useState('');
    
    const initialFormState = {
        id: '',
        fullName: '',
        email: '',
        phone: '',
        subject: '',
        qualification: '',
        salary: 0,
        joinDate: new Date().toISOString().split('T')[0]
    };
    const [formData, setFormData] = useState(initialFormState);
    
    const [attendanceDate, setAttendanceDate] = useState(new Date().toISOString().split('T')[0]);
    const [attendanceMap, setAttendanceMap] = useState({});

    useEffect(() => {
        loadTeachers();
    }, []);

    useEffect(() => {
        if (activeTab === 'ATTENDANCE') {
            loadAttendance();
        }
    }, [activeTab, attendanceDate]);

    const loadTeachers = () => {
        setTeachers(db.getTeachers());
    };

    const loadAttendance = () => {
        const allRecs = db.getTeacherAttendance();
        const todaysRecs = allRecs.filter(r => r.date === attendanceDate);
        const map = {};
        todaysRecs.forEach(r => map[r.teacherId] = r.status);
        setAttendanceMap(map);
    };

    const validateForm = () => {
        if (!formData.fullName.trim()) return "Full Name is required";
        if (!formData.subject.trim()) return "Subject is required";
        
        if (formData.email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(formData.email)) return "Invalid email address format";
        }
        if (formData.phone) {
            const phoneRegex = /^\d{10}$/;
            if (!phoneRegex.test(formData.phone)) return "Phone number must be exactly 10 digits";
        }
        if (formData.salary <= 0) return "Salary must be a positive number greater than zero";
        return null;
    };

    const handleSaveTeacher = (e) => {
        e.preventDefault();
        const error = validateForm();
        if (error) {
            alert(error);
            return;
        }
        const teacher = { ...formData, id: formData.id || Date.now().toString() };
        db.saveTeacher(teacher);
        setShowForm(false);
        loadTeachers();
        setFormData(initialFormState);
    };

    const handleDelete = (id) => {
        if(confirm("Are you sure you want to delete this teacher? This action cannot be undone.")) {
            db.deleteTeacher(id);
            loadTeachers();
        }
    };

    const markAttendance = (teacherId, status) => {
        const record = {
            id: `${teacherId}-${attendanceDate}`,
            teacherId,
            date: attendanceDate,
            status
        };
        db.saveTeacherAttendance(record);
        loadAttendance();
    };

    const changeDate = (days) => {
        const date = new Date(attendanceDate);
        date.setUTCDate(date.getUTCDate() + days);
        setAttendanceDate(date.toISOString().split('T')[0]);
    };

    const filteredTeachers = teachers.filter(t => 
        t.fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||
        t.subject.toLowerCase().includes(searchTerm.toLowerCase())
    );

    return (
        <div className="bg-black/40 backdrop-blur-xl rounded-xl shadow-sm border border-white/10 h-full flex flex-col">
            <div className="p-4 md:p-6 border-b border-white/10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <h2 className="text-xl font-bold text-white">Teacher Management</h2>
                <div className="flex w-full md:w-auto gap-2 bg-white/5 p-1 rounded-lg border border-white/10">
                    <button 
                        onClick={() => setActiveTab('LIST')} 
                        className={`flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'LIST' ? 'bg-white/10 text-indigo-300 shadow-sm' : 'text-zinc-400 hover:text-zinc-200'}`}
                    >
                        Staff Directory
                    </button>
                    <button 
                        onClick={() => setActiveTab('ATTENDANCE')} 
                        className={`flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all ${activeTab === 'ATTENDANCE' ? 'bg-white/10 text-indigo-300 shadow-sm' : 'text-zinc-400 hover:text-zinc-200'}`}
                    >
                        Attendance
                    </button>
                </div>
            </div>

            <div className="flex-1 overflow-hidden p-4 md:p-6">
                {activeTab === 'LIST' && (
                    <>
                        <div className="flex flex-col md:flex-row justify-between items-stretch md:items-center gap-4 mb-6">
                            <div className="relative w-full md:w-72">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400" size={18} />
                                <input 
                                    type="text" 
                                    placeholder="Search teachers..." 
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="w-full pl-10 pr-4 py-2 border border-white/10 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none bg-white/5 text-white placeholder-zinc-500"
                                />
                            </div>
                            <button 
                                onClick={() => { setShowForm(true); setFormData(initialFormState); }}
                                className="flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md shadow-indigo-900/50 font-medium"
                            >
                                <UserPlus size={18} /> Add Teacher
                            </button>
                        </div>

                        {showForm && (
                            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                                <div className="bg-zinc-900/90 backdrop-blur-xl rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-in zoom-in-95 duration-200 border border-white/10">
                                    <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                                        <h3 className="font-bold text-lg text-white">{formData.id ? 'Edit Teacher Details' : 'Add New Teacher'}</h3>
                                        <button onClick={() => setShowForm(false)} className="text-zinc-400 hover:text-white"><X size={20}/></button>
                                    </div>
                                    <form onSubmit={handleSaveTeacher} className="p-6 space-y-5">
                                        <div>
                                            <label className="block text-sm font-medium text-zinc-300 mb-1">Full Name <span className="text-red-500">*</span></label>
                                            <input 
                                                type="text" 
                                                required 
                                                className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5" 
                                                placeholder="e.g. Dr. Sarah Smith"
                                                value={formData.fullName} 
                                                onChange={e => setFormData({...formData, fullName: e.target.value})} 
                                            />
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-zinc-300 mb-1">Subject <span className="text-red-500">*</span></label>
                                                <input 
                                                    type="text" 
                                                    required 
                                                    className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5"
                                                    placeholder="e.g. Physics" 
                                                    value={formData.subject} 
                                                    onChange={e => setFormData({...formData, subject: e.target.value})} 
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-zinc-300 mb-1">Qualification</label>
                                                <input 
                                                    type="text" 
                                                    className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5" 
                                                    placeholder="e.g. M.Sc, B.Ed"
                                                    value={formData.qualification} 
                                                    onChange={e => setFormData({...formData, qualification: e.target.value})} 
                                                />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-zinc-300 mb-1">Phone (10-digit)</label>
                                                <input 
                                                    type="tel" 
                                                    className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5" 
                                                    placeholder="9876543210"
                                                    maxLength={10}
                                                    value={formData.phone} 
                                                    onChange={e => setFormData({...formData, phone: e.target.value})} 
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-zinc-300 mb-1">Email</label>
                                                <input 
                                                    type="email" 
                                                    className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5" 
                                                    placeholder="teacher@school.com"
                                                    value={formData.email} 
                                                    onChange={e => setFormData({...formData, email: e.target.value})} 
                                                />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <label className="block text-sm font-medium text-zinc-300 mb-1">Salary () <span className="text-red-500">*</span></label>
                                                <input 
                                                    type="number" 
                                                    required 
                                                    min="1"
                                                    className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5" 
                                                    placeholder="50000"
                                                    value={formData.salary || ''} 
                                                    onChange={e => setFormData({...formData, salary: parseInt(e.target.value) || 0})} 
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-zinc-300 mb-1">Join Date</label>
                                                <input 
                                                    type="date" 
                                                    className="w-full p-2.5 border border-white/10 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-white bg-white/5 [color-scheme:dark]" 
                                                    value={formData.joinDate} 
                                                    onChange={e => setFormData({...formData, joinDate: e.target.value})} 
                                                />
                                            </div>
                                        </div>
                                        <div className="pt-4 flex gap-3">
                                            <button type="submit" className="flex-1 bg-indigo-600 text-white py-2.5 rounded-lg hover:bg-indigo-700 font-medium shadow-md shadow-indigo-900/50 transition">
                                                {formData.id ? 'Update Details' : 'Register Teacher'}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        <div className="overflow-auto h-[calc(100vh-240px)] pr-2 custom-scrollbar">
                            {filteredTeachers.length > 0 ? (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-5">
                                    {filteredTeachers.map(teacher => (
                                        <div key={teacher.id} className="p-5 bg-white/5 border border-white/10 rounded-xl hover:shadow-lg transition-all group hover:bg-white/10 backdrop-blur-sm">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <h3 className="font-bold text-lg text-white group-hover:text-indigo-300 transition-colors">{teacher.fullName}</h3>
                                                    <span className="inline-block mt-1 text-xs bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded-full font-medium border border-indigo-500/20">
                                                        {teacher.subject}
                                                    </span>
                                                </div>
                                                <div className="flex gap-1 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button onClick={() => { setFormData(teacher); setShowForm(true); }} className="p-2 text-blue-300 hover:bg-blue-900/30 rounded-full transition"><Edit size={16}/></button>
                                                    <button onClick={() => handleDelete(teacher.id)} className="p-2 text-red-300 hover:bg-red-900/30 rounded-full transition"><Trash2 size={16}/></button>
                                                </div>
                                            </div>
                                            
                                            <div className="space-y-2 text-sm text-zinc-400 pt-2 border-t border-white/10">
                                                <div className="flex items-center gap-2.5">
                                                    <Phone size={14} className="text-zinc-500"/> 
                                                    <span>{teacher.phone || 'N/A'}</span>
                                                </div>
                                                <div className="flex items-center gap-2.5">
                                                    <Mail size={14} className="text-zinc-500"/> 
                                                    <span className="truncate">{teacher.email || 'N/A'}</span>
                                                </div>
                                                <div className="flex items-center gap-2.5">
                                                    <IndianRupee size={14} className="text-zinc-500"/> 
                                                    <span className="font-medium text-zinc-300">{teacher.salary.toLocaleString()}</span>
                                                </div>
                                                <div className="flex items-center gap-2.5">
                                                    <Calendar size={14} className="text-zinc-500"/> 
                                                    <span>Joined: {teacher.joinDate}</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-12 text-zinc-500">
                                    No teachers found matching your search.
                                </div>
                            )}
                        </div>
                    </>
                )}

                {activeTab === 'ATTENDANCE' && (
                    <div className="h-full flex flex-col bg-white/5 rounded-lg border border-white/10 shadow-sm overflow-hidden backdrop-blur-md">
                        <div className="flex flex-col lg:flex-row items-start lg:items-center gap-4 bg-white/5 p-4 border-b border-white/10">
                            <div className="flex items-center gap-1 bg-black/20 border border-white/10 rounded-lg p-1 w-full lg:w-auto justify-between lg:justify-start">
                                <button onClick={() => changeDate(-1)} className="p-2 hover:bg-white/10 rounded text-zinc-400"><ChevronLeft size={18}/></button>
                                <div className="flex items-center gap-2 px-2 border-x border-white/10 flex-1 justify-center lg:flex-none">
                                    <Calendar size={16} className="text-indigo-400"/>
                                    <input 
                                        type="date" 
                                        value={attendanceDate} 
                                        onChange={(e) => setAttendanceDate(e.target.value)}
                                        className="text-sm text-white outline-none bg-transparent font-medium w-32 [color-scheme:dark]"
                                    />
                                </div>
                                <button onClick={() => changeDate(1)} className="p-2 hover:bg-white/10 rounded text-zinc-400"><ChevronRight size={18}/></button>
                            </div>
                            
                            <button 
                                onClick={() => setAttendanceDate(new Date().toISOString().split('T')[0])}
                                className="text-xs font-medium text-indigo-300 hover:text-indigo-200 underline hidden lg:block"
                            >
                                Jump to Today
                            </button>

                            <div className="lg:ml-auto flex w-full lg:w-auto gap-2 text-sm">
                                <div className="flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-1.5 bg-green-500/20 text-green-300 rounded-lg border border-green-500/20">
                                    <span className="w-2 h-2 rounded-full bg-green-500"></span>
                                    <span className="text-xs md:text-sm">Present: <span className="font-bold">{Object.values(attendanceMap).filter(v => v === 'Present').length}</span></span>
                                </div>
                                <div className="flex-1 lg:flex-none flex items-center justify-center gap-2 px-3 py-1.5 bg-red-500/20 text-red-300 rounded-lg border border-red-500/20">
                                    <span className="w-2 h-2 rounded-full bg-red-500"></span>
                                    <span className="text-xs md:text-sm">Absent: <span className="font-bold">{Object.values(attendanceMap).filter(v => v === 'Absent').length}</span></span>
                                </div>
                            </div>
                        </div>

                        <div className="overflow-x-auto flex-1 custom-scrollbar">
                            <table className="w-full text-left text-sm text-zinc-300 min-w-[600px]">
                                <thead className="bg-white/5 text-zinc-200 uppercase font-semibold text-xs sticky top-0 z-10 backdrop-blur-md">
                                    <tr>
                                        <th className="p-4 border-b border-white/10 w-1/3">Teacher Name</th>
                                        <th className="p-4 border-b border-white/10">Subject</th>
                                        <th className="p-4 border-b border-white/10 text-center">Status</th>
                                        <th className="p-4 border-b border-white/10 text-right">Mark Attendance</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-white/10">
                                    {teachers.map(teacher => {
                                        const status = attendanceMap[teacher.id];
                                        return (
                                            <tr key={teacher.id} className="hover:bg-white/5 transition-colors">
                                                <td className="p-4">
                                                    <div className="font-medium text-white">{teacher.fullName}</div>
                                                    <div className="text-xs text-zinc-400">{teacher.email}</div>
                                                </td>
                                                <td className="p-4">
                                                    <span className="px-2 py-1 bg-white/10 rounded text-zinc-300 text-xs font-medium border border-white/10">
                                                        {teacher.subject}
                                                    </span>
                                                </td>
                                                <td className="p-4 text-center">
                                                    {status === 'Present' && (
                                                        <span className="inline-flex items-center gap-1 text-green-300 font-bold px-2.5 py-1 bg-green-500/20 rounded-full text-xs">
                                                            <CheckCircle size={12} /> Present
                                                        </span>
                                                    )}
                                                    {status === 'Absent' && (
                                                        <span className="inline-flex items-center gap-1 text-red-300 font-bold px-2.5 py-1 bg-red-500/20 rounded-full text-xs">
                                                            <XCircle size={12} /> Absent
                                                        </span>
                                                    )}
                                                    {!status && <span className="text-zinc-500 text-xs italic">--</span>}
                                                </td>
                                                <td className="p-4 text-right">
                                                    <div className="flex justify-end gap-2">
                                                        <button 
                                                            onClick={() => markAttendance(teacher.id, 'Present')}
                                                            className={`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${status === 'Present' ? 'bg-green-600 text-white shadow-md shadow-green-900/50' : 'bg-white/5 border border-white/10 text-zinc-400 hover:border-green-500 hover:text-green-400'}`}
                                                        >
                                                            Present
                                                        </button>
                                                        <button 
                                                            onClick={() => markAttendance(teacher.id, 'Absent')}
                                                            className={`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all ${status === 'Absent' ? 'bg-red-600 text-white shadow-md shadow-red-900/50' : 'bg-white/5 border border-white/10 text-zinc-400 hover:border-red-500 hover:text-red-400'}`}
                                                        >
                                                            Absent
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {teachers.length === 0 && (
                                <div className="text-center py-12 text-zinc-500">No teachers available. Add teachers from the Staff Directory tab.</div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// 8. DASHBOARD
const StatCard = ({ title, value, icon: Icon, color }) => (
    <div className="bg-black/40 backdrop-blur-xl p-6 rounded-xl shadow-lg border border-white/10 flex items-center gap-4 hover:bg-black/50 transition-all">
        <div className={`${color} p-3 md:p-4 rounded-lg text-white shadow-lg shadow-black/20 shrink-0`}>
            <Icon size={20} className="md:w-6 md:h-6" />
        </div>
        <div className="min-w-0">
            <p className="text-zinc-400 text-xs md:text-sm font-medium truncate">{title}</p>
            <h3 className="text-lg md:text-2xl font-bold text-white truncate">{value}</h3>
        </div>
    </div>
);

const DashboardHome = ({ stats, onNavigate }) => {
    const pieData = [
        { name: 'Boys', value: stats.genderStats?.male || 0 },
        { name: 'Girls', value: stats.genderStats?.female || 0 },
    ];
    
    const COLORS = ['#6366f1', '#ec4899'];

    return (
        <div className="space-y-6 overflow-y-auto h-full pb-24 custom-scrollbar pr-1">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 md:gap-6">
                <StatCard title="Total Students" value={stats.totalStudents} icon={Users} color="bg-indigo-600" />
                <StatCard title="Active Teachers" value={stats.totalTeachers} icon={GraduationCap} color="bg-teal-600" />
                <StatCard title="Fees Collected" value={`${stats.totalRevenue.toLocaleString()}`} icon={IndianRupee} color="bg-green-600" />
                <StatCard title="Present Today" value={stats.attendanceToday} icon={CheckSquare} color="bg-orange-600" />
                <StatCard title="Exam Pass Rate" value={`${stats.passPercentage}%`} icon={Award} color="bg-purple-600" />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2 bg-black/40 backdrop-blur-xl p-6 rounded-xl shadow-lg border border-white/10">
                    <h3 className="text-lg font-bold text-white mb-4">Quick Shortcuts</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div 
                            onClick={() => onNavigate(View.STUDENTS)}
                            className="p-4 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition cursor-pointer flex flex-col items-center text-center group"
                        >
                            <div className="p-3 bg-indigo-500/20 rounded-full text-indigo-300 mb-2 shadow-sm group-hover:text-indigo-200"><Users size={24}/></div>
                            <span className="font-medium text-zinc-300 group-hover:text-white text-sm">New Admission</span>
                        </div>
                        <div 
                            onClick={() => onNavigate(View.TEACHERS)}
                            className="p-4 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition cursor-pointer flex flex-col items-center text-center group"
                        >
                            <div className="p-3 bg-teal-500/20 rounded-full text-teal-300 mb-2 shadow-sm group-hover:text-teal-200"><GraduationCap size={24}/></div>
                            <span className="font-medium text-zinc-300 group-hover:text-white text-sm">Manage Teachers</span>
                        </div>
                        <div 
                            onClick={() => onNavigate(View.FEES)}
                            className="p-4 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition cursor-pointer flex flex-col items-center text-center group"
                        >
                            <div className="p-3 bg-green-500/20 rounded-full text-green-300 mb-2 shadow-sm group-hover:text-green-200"><IndianRupee size={24}/></div>
                            <span className="font-medium text-zinc-300 group-hover:text-white text-sm">Collect Fees</span>
                        </div>
                        <div 
                            onClick={() => onNavigate(View.ATTENDANCE)}
                            className="p-4 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition cursor-pointer flex flex-col items-center text-center group"
                        >
                            <div className="p-3 bg-orange-500/20 rounded-full text-orange-300 mb-2 shadow-sm group-hover:text-orange-200"><CheckSquare size={24}/></div>
                            <span className="font-medium text-zinc-300 group-hover:text-white text-sm">Mark Attendance</span>
                        </div>
                        <div 
                            onClick={() => onNavigate(View.EXAMS)}
                            className="p-4 bg-white/5 rounded-lg border border-white/5 hover:bg-white/10 transition cursor-pointer flex flex-col items-center text-center group"
                        >
                            <div className="p-3 bg-purple-500/20 rounded-full text-purple-300 mb-2 shadow-sm group-hover:text-purple-200"><Award size={24}/></div>
                            <span className="font-medium text-zinc-300 group-hover:text-white text-sm">Publish Results</span>
                        </div>
                    </div>
                </div>

                <div className="bg-black/40 backdrop-blur-xl p-6 rounded-xl shadow-lg border border-white/10 flex flex-col">
                    <h3 className="text-lg font-bold text-white mb-2 flex items-center gap-2">
                        <PieChart size={20} className="text-zinc-400"/> Demographics
                    </h3>
                    <div className="flex-1 min-h-[200px]">
                        {stats.totalStudents > 0 ? (
                            <ResponsiveContainer width="100%" height="100%">
                                <RePieChart>
                                    <Pie
                                        data={pieData}
                                        cx="50%"
                                        cy="50%"
                                        innerRadius={60}
                                        outerRadius={80}
                                        fill="#8884d8"
                                        paddingAngle={5}
                                        dataKey="value"
                                        stroke="none"
                                    >
                                        {pieData.map((entry, index) => (
                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                        ))}
                                    </Pie>
                                    <Tooltip contentStyle={{backgroundColor: 'rgba(0,0,0,0.8)', borderColor: 'rgba(255,255,255,0.1)', color: '#f4f4f5', borderRadius: '8px'}} />
                                </RePieChart>
                            </ResponsiveContainer>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-zinc-500 text-sm">
                                <PieChart size={48} className="opacity-20 mb-2" />
                                No student data available
                            </div>
                        )}
                    </div>
                    <div className="flex justify-center gap-6 text-sm text-zinc-300 mt-4">
                        <div className="flex items-center gap-2">
                            <span className="w-3 h-3 rounded-full bg-indigo-500"></span> 
                            Boys <span className="text-zinc-500 text-xs">({stats.genderStats?.male || 0})</span>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="w-3 h-3 rounded-full bg-pink-500"></span> 
                            Girls <span className="text-zinc-500 text-xs">({stats.genderStats?.female || 0})</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div className="bg-gradient-to-r from-indigo-900/80 to-purple-900/80 border border-white/10 text-white rounded-xl p-8 relative overflow-hidden backdrop-blur-sm shadow-lg">
                 <div className="relative z-10">
                     <h2 className="text-2xl font-bold mb-2">Udaan Vidhyalay Pro</h2>
                     <p className="text-indigo-100 max-w-xl">Manage your institution with the latest tools in education technology. Secure database, automated reports, and AI insights.</p>
                 </div>
            </div>
        </div>
    );
}

const Dashboard = ({ onLogout }) => {
  const [currentView, setCurrentView] = useState(View.DASHBOARD);
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [stats, setStats] = useState({
      totalStudents: 0,
      totalTeachers: 0,
      totalRevenue: 0,
      attendanceToday: 0,
      passPercentage: 0,
      genderStats: { male: 0, female: 0 }
  });

  useEffect(() => {
      db.initializeData();
      updateStats();
      const interval = setInterval(updateStats, 2000);
      return () => clearInterval(interval);
  }, []);

  const updateStats = () => {
      const students = db.getStudents();
      const fees = db.getFees();
      const attendance = db.getAttendance();
      const exams = db.getExams();
      const teacherCount = db.getTeacherCount();

      const revenue = fees.reduce((acc, curr) => {
          return acc + (curr.semester1Paid ? 11000 : 0) + (curr.semester2Paid ? 11000 : 0);
      }, 0);

      const today = new Date().toISOString().split('T')[0];
      const presentToday = attendance.filter(a => a.date === today && a.status === 'Present').length;

      const passed = exams.filter(e => e.marksObtained >= 40).length;
      const passRate = exams.length > 0 ? Math.round((passed / exams.length) * 100) : 0;

      const maleCount = students.filter(s => s.gender === 'Male').length;
      const femaleCount = students.filter(s => s.gender === 'Female').length;

      setStats({
          totalStudents: students.length,
          totalTeachers: teacherCount,
          totalRevenue: revenue,
          attendanceToday: presentToday,
          passPercentage: passRate,
          genderStats: { male: maleCount, female: femaleCount }
      });
  };

  const renderContent = () => {
    switch (currentView) {
      case View.STUDENTS:
        return <StudentManager />;
      case View.TEACHERS:
        return <TeacherManager />;
      case View.FEES:
        return <FeesManager />;
      case View.ATTENDANCE:
        return <AttendanceManager />;
      case View.EXAMS:
        return <ExamManager />;
      case View.DASHBOARD:
      default:
        return <DashboardHome stats={stats} onNavigate={setCurrentView} />;
    }
  };

  return (
    <div className="flex min-h-screen bg-transparent text-zinc-100">
      <Sidebar 
        currentView={currentView} 
        onChangeView={setCurrentView} 
        onLogout={onLogout} 
        isOpen={isSidebarOpen}
        onClose={() => setIsSidebarOpen(false)}
      />
      
      <main className={`flex-1 p-4 md:p-8 overflow-hidden h-screen flex flex-col transition-all duration-300 ${isSidebarOpen ? 'md:ml-64' : 'md:ml-64'}`}>
        <header className="flex justify-between items-center mb-6 md:mb-8 shrink-0">
             <div className="flex items-center gap-4">
                <button 
                    onClick={() => setIsSidebarOpen(true)}
                    className="md:hidden p-2 text-zinc-300 hover:text-white hover:bg-white/10 rounded-lg transition-colors"
                >
                    <Menu size={24} />
                </button>
                <div>
                    <h1 className="text-xl md:text-2xl font-bold text-white drop-shadow-sm">{currentView === View.DASHBOARD ? 'Overview' : currentView.replace('_', ' ')}</h1>
                    <p className="text-zinc-300 text-xs md:text-sm hidden sm:block">Welcome back, Administrator.</p>
                </div>
             </div>
             <div className="text-xs md:text-sm bg-black/30 backdrop-blur-md px-3 py-1.5 md:px-4 md:py-2 rounded-full shadow-sm text-zinc-200 border border-white/10 whitespace-nowrap">
                 {new Date().toLocaleDateString('en-IN', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })}
             </div>
        </header>
        
        <div className="flex-1 overflow-hidden relative">
            {renderContent()}
        </div>
      </main>
    </div>
  );
};

// 9. APP & ROOT RENDER
const App = () => {
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  useEffect(() => {
    const auth = sessionStorage.getItem('uv_auth');
    if (auth === 'true') setIsAuthenticated(true);
  }, []);

  const handleLogin = () => {
    sessionStorage.setItem('uv_auth', 'true');
    setIsAuthenticated(true);
  };

  const handleLogout = () => {
    sessionStorage.removeItem('uv_auth');
    setIsAuthenticated(false);
  };

  return (
    <>
      {isAuthenticated ? (
        <Dashboard onLogout={handleLogout} />
      ) : (
        <Login onLogin={handleLogin} />
      )}
    </>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

    </script>
</body>
</html>